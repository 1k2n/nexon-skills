const { useEffect, useMemo, useState } = window.React;
const { Clock } = window.LucideReact;
const { NewsThumbnail } = window.AppComponents;

const AINews = ({ setSelectedItem }) => {
            const [newsItems, setNewsItems] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [errorMessage, setErrorMessage] = useState('');

            const feedUrl = useMemo(
                () => 'https://r.jina.ai/http://news.google.com/rss/search?q=%EC%9D%B8%EA%B3%B5%EC%A7%80%EB%8A%A5%20AI&hl=ko&gl=KR&ceid=KR:ko',
                []
            );

            const hasHangul = (value) => /[ê°€-í£]/.test(value || '');

            const formatRelativeTime = (dateString) => {
                const date = new Date(dateString);
                if (Number.isNaN(date.getTime())) return 'ë°©ê¸ˆ ì „';
                const diffMs = Date.now() - date.getTime();
                const minutes = Math.floor(diffMs / 60000);
                if (minutes < 1) return 'ë°©ê¸ˆ ì „';
                if (minutes < 60) return `${minutes}ë¶„ ì „`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}ì‹œê°„ ì „`;
                const days = Math.floor(hours / 24);
                if (days < 7) return `${days}ì¼ ì „`;
                return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
            };

            const getCategory = (title, description) => {
                const text = `${title} ${description}`;
                if (/(ëª¨ë¸|ì¶œì‹œ|ì—…ë°ì´íŠ¸|ë²„ì „|ë¦¬ë¦¬ì¦ˆ)/.test(text)) return 'Model Update';
                if (/(ê°€ì´ë“œ|íŠœí† ë¦¬ì–¼|ë°©ë²•|íŒ|ê°•ì¢Œ)/.test(text)) return 'Tutorial';
                if (/(íˆ¬ì|ê¸°ì—…|ì‹œì¥|ì‚°ì—…|ì‹¤ì |íŒŒíŠ¸ë„ˆì‹­|ì¸ìˆ˜|í•©ë³‘)/.test(text)) return 'Industry';
                return 'Community';
            };

            const parseFeed = (xmlText) => {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                if (xmlDoc.querySelector('parsererror')) {
                    throw new Error('í”¼ë“œ íŒŒì‹± ì˜¤ë¥˜');
                }
                return Array.from(xmlDoc.querySelectorAll('item'))
                    .map((item) => {
                        const titleText = item.querySelector('title')?.textContent?.trim() || '';
                        const [title, source = 'AI News'] = titleText.split(' - ');
                        const descriptionHtml = item.querySelector('description')?.textContent || '';
                        const descriptionText = new DOMParser()
                            .parseFromString(descriptionHtml, 'text/html')
                            .body.textContent?.trim() || '';
                        const pubDate = item.querySelector('pubDate')?.textContent || '';
                        const link = item.querySelector('link')?.textContent || '';
                        return {
                            title: title || titleText,
                            source,
                            description: descriptionText,
                            date: formatRelativeTime(pubDate),
                            category: getCategory(titleText, descriptionText),
                            link,
                        };
                    })
                    .filter((news) => hasHangul(news.title) || hasHangul(news.description))
                    .slice(0, 9);
            };

            useEffect(() => {
                let isMounted = true;
                const loadNews = async () => {
                    try {
                        setIsLoading(true);
                        const response = await fetch(feedUrl);
                        if (!response.ok) {
                            throw new Error('ë‰´ìŠ¤ í”¼ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        }
                        const xmlText = await response.text();
                        const items = parseFeed(xmlText);
                        if (isMounted) {
                            setNewsItems(items);
                            setErrorMessage(items.length ? '' : 'í˜„ì¬ í‘œì‹œí•  í•œêµ­ì–´ AI ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        if (isMounted) {
                            setErrorMessage('ì‹¤ì‹œê°„ ë‰´ìŠ¤ í”¼ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    } finally {
                        if (isMounted) {
                            setIsLoading(false);
                        }
                    }
                };
                loadNews();
                return () => {
                    isMounted = false;
                };
            }, [feedUrl]);

            return (
                <div className="space-y-8 animate-in relative"><div className="border-b-2 border-slate-200 pb-6"><h2 className="text-4xl font-bold text-slate-900">ìŠ¤í‚¬ íŠ¸ë Œë“œ</h2><p className="text-slate-500 font-medium mt-2 text-lg">ì „ ì„¸ê³„ì˜ í˜ì‹ ì ì¸ AI ì†Œì‹ì„ ì„ ë³„í•˜ì—¬ ì „ë‹¬í•©ë‹ˆë‹¤.</p></div>
                    {isLoading ? (
                        <div className="flex items-center justify-center py-16 text-slate-500 font-semibold text-lg">
                            ì‹¤ì‹œê°„ AI ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    ) : errorMessage ? (
                        <div className="flex items-center justify-center py-16 text-slate-500 font-semibold text-lg">
                            {errorMessage}
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {newsItems.map((news, i) => (
                                <div
                                    key={i}
                                    className="group cursor-pointer relative hover:z-10"
                                    onClick={() =>
                                        setSelectedItem({
                                            type: 'News',
                                            title: news.title,
                                            desc: `${news.description}\n\nğŸ”— ì›ë¬¸: ${news.link}`,
                                            author: `${news.date} â€¢ ${news.source}`,
                                        })
                                    }
                                >
                                    <NewsThumbnail category={news.category} />
                                    <div className="px-2">
                                        <p className="text-xs font-bold text-slate-400 mb-2 flex items-center gap-1">
                                            <Clock size={12} /> {news.date}
                                        </p>
                                        <h3 className="text-xl font-bold text-slate-900 leading-snug group-hover:text-blue-600 transition-colors">
                                            {news.title}
                                        </h3>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

window.AppComponents.AINews = AINews;
