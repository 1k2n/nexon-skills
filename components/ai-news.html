const { Clock } = window.LucideReact;
const { useEffect, useState } = window.React;
const { NewsThumbnail } = window.AppComponents;

const FEED_URL = 'https://feeds.feedburner.com/geeknews-feed';
const FEED_PROXY = 'https://r.jina.ai/http://';

const fetchFeedText = async (url, signal) => {
    const response = await fetch(url, { signal });
    if (!response.ok) {
        throw new Error(`Feed fetch failed: ${response.status}`);
    }
    return response.text();
};

const formatDate = (dateString) => {
    const date = new Date(dateString);
    if (Number.isNaN(date.getTime())) {
        return dateString;
    }
    return date.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
    });
};

const stripHtml = (value) => value.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();

const mapFeedItems = (items) =>
    items.map((item) => {
        const title = item.querySelector('title')?.textContent?.trim() ?? 'Untitled';
        const link = item.querySelector('link')?.textContent?.trim() ?? '';
        const descriptionRaw = item.querySelector('description')?.textContent ?? '';
        const description = stripHtml(descriptionRaw).slice(0, 200);
        const pubDate = item.querySelector('pubDate')?.textContent ?? '';
        return {
            category: 'GeekNews',
            title,
            date: formatDate(pubDate),
            content: description || '요약 정보를 불러오는 중입니다.',
            link,
        };
    });

const AINews = ({ setSelectedItem }) => {
    const [newsItems, setNewsItems] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [loadError, setLoadError] = useState(false);

    useEffect(() => {
        const controller = new AbortController();

        const fetchFeed = async () => {
            try {
                let xmlText;
                try {
                    xmlText = await fetchFeedText(FEED_URL, controller.signal);
                } catch (error) {
                    xmlText = await fetchFeedText(`${FEED_PROXY}${FEED_URL}`, controller.signal);
                }
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlText, 'text/xml');
                if (xml.querySelector('parsererror')) {
                    throw new Error('Invalid RSS XML');
                }
                const items = Array.from(xml.querySelectorAll('item')).slice(0, 9);
                const mappedItems = mapFeedItems(items);
                setNewsItems(mappedItems);
                setLoadError(mappedItems.length === 0);
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('GeekNews feed error', error);
                    setLoadError(true);
                }
            } finally {
                setIsLoading(false);
            }
        };

        fetchFeed();

        return () => controller.abort();
    }, []);

    return (
        <div className="space-y-8 animate-in relative">
            <div className="border-b-2 border-slate-200 pb-6">
                <h2 className="text-4xl font-bold text-slate-900">스킬 트렌드</h2>
                <p className="text-slate-500 font-medium mt-2 text-lg">
                    전 세계의 혁신적인 AI 소식을 선별하여 전달합니다.
                </p>
                <p className="text-sm text-slate-400 mt-2">
                    {isLoading && 'GeekNews 피드를 불러오는 중입니다.'}
                    {!isLoading && !loadError && 'GeekNews 최신 피드를 반영했습니다.'}
                    {!isLoading && loadError && '현재 GeekNews 피드를 불러올 수 없습니다.'}
                </p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {newsItems.length === 0 && !isLoading ? (
                    <div className="col-span-full text-center text-slate-400 font-medium py-12">
                        현재 표시할 GeekNews 항목이 없습니다.
                    </div>
                ) : (
                    newsItems.map((news, i) => (
                        <div
                            key={`${news.title}-${i}`}
                            className="group cursor-pointer relative hover:z-10"
                            onClick={() =>
                                setSelectedItem({
                                    type: 'News',
                                    title: news.title,
                                    desc: news.content,
                                    author: `${news.date} • GeekNews`,
                                })
                            }
                        >
                            <NewsThumbnail category={news.category} />
                            <div className="px-2">
                                <p className="text-xs font-bold text-slate-400 mb-2 flex items-center gap-1">
                                    <Clock size={12} /> {news.date}
                                </p>
                                <h3 className="text-xl font-bold text-slate-900 leading-snug group-hover:text-blue-600 transition-colors">
                                    {news.title}
                                </h3>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>
    );
};

window.AppComponents.AINews = AINews;
