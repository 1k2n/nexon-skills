const { useMemo, useRef, useState } = window.React;
const { Sparkles, Bot, Workflow, Braces, Check, PlayCircle, Clipboard, X, FileText } = window.LucideReact;

const AIStudio = () => {
    const [masterPrompt, setMasterPrompt] = useState('오늘 시작한 "설맞이 일일 퀘스트" 의 매출 효과를 일별로 분석하고, 그 기간동안의 동접 변화를 추적하고, 전날 결과를 취합해서 매일 아침 9시에 기획팀 메일과 슬랙 채널에 쏴줘.');
    const [isAnalyzed, setIsAnalyzed] = useState(false);
    const [isRan, setIsRan] = useState(false);
    const [isCopied, setIsCopied] = useState(false);
    const [isLogOpen, setIsLogOpen] = useState(false);
    const [selectedNode, setSelectedNode] = useState(null);
    const [canvasOffset, setCanvasOffset] = useState({ x: 0, y: 0 });
    const [isPanning, setIsPanning] = useState(false);
    const panStartRef = useRef({ x: 0, y: 0 });

    const nodePositions = useMemo(() => ({
        node_0: { x: 120, y: 150 },
        node_1: { x: 430, y: 70 },
        node_2: { x: 430, y: 250 },
        node_5: { x: 740, y: 150 },
        node_3: { x: 1040, y: 70 },
        node_4: { x: 1040, y: 250 },
        node_6: { x: 1340, y: 150 },
    }), []);

    const plannedSkills = useMemo(() => ([
        {
            id: 'node_0',
            skill: 'normalize_kpi_request',
            route: 'skills://planner-router',
            skillName: 'KPI Planner',
            output: 'analysis_window=2026-02-13~2026-02-19',
            origin: 'catalog',
            originLabel: '스킬 라이브러리',
            detail: '유저 입력을 KPI 쿼리/기간/채널 파라미터로 정규화합니다.',
        },
        {
            id: 'node_1',
            skill: 'daily_revenue_impact_search',
            route: 'skills:ai-search-agent',
            skillName: 'AI 서치 에이전트',
            output: '일매출 +8.4%, 퀘스트 기여매출 1.98억 원',
            origin: 'catalog',
            originLabel: '스킬 라이브러리',
            detail: '매출 로그와 이벤트 테이블을 탐색해 일별 영향도를 계산합니다.',
        },
        {
            id: 'node_2',
            skill: 'ccu_variation_tracking',
            route: 'skills:nemort-agent',
            skillName: 'NEMO RT 에이전트',
            output: '평균 동접 +11.7%, 피크 동접 +14.2%',
            origin: 'catalog',
            originLabel: '스킬 라이브러리',
            detail: 'CCU 스트림을 추적해서 평균/피크 변동량을 산출합니다.',
        },
        {
            id: 'node_5',
            skill: 'merge_daily_kpi',
            route: 'skills://runtime/instant-merge-kpi',
            skillName: 'Daily KPI Joiner',
            output: '전날 종합 브리프(JSON) 생성 완료',
            origin: 'instant',
            originLabel: '인스턴트 스킬 (1회성)',
            detail: '이번 실행 계획에서만 생성된 임시 스킬로, 매출/동접 결과를 브리프 포맷으로 병합합니다.',
        },
        {
            id: 'node_3',
            skill: 'compose_email_digest',
            route: 'skills:email-summary',
            skillName: 'Email Summary',
            output: '기획팀 메일 발송 성공 (09:00 KST)',
            origin: 'catalog',
            originLabel: '스킬 라이브러리',
            detail: '브리프를 이메일 템플릿으로 렌더링해 예약 발송합니다.',
        },
        {
            id: 'node_4',
            skill: 'publish_slack_digest',
            route: 'skills:slack-notifier',
            skillName: 'Slack Notifier',
            output: '#planning-daily 채널 전송 성공 (09:00 KST)',
            origin: 'catalog',
            originLabel: '스킬 라이브러리',
            detail: '브리프 요약을 슬랙 채널 카드 메시지 형태로 게시합니다.',
        },
        {
            id: 'node_6',
            skill: 'archive_delivery_status',
            route: 'skills://ops-audit-log',
            skillName: 'Delivery Audit',
            output: 'delivery_id=DLV-20260220-090001',
            origin: 'catalog',
            originLabel: '스킬 라이브러리',
            detail: '각 전송 결과를 감사 로그 저장소에 기록합니다.',
        },
    ]), [masterPrompt]);

    const edges = useMemo(() => ([
        ['node_0', 'node_1'],
        ['node_0', 'node_2'],
        ['node_1', 'node_5'],
        ['node_2', 'node_5'],
        ['node_5', 'node_3'],
        ['node_5', 'node_4'],
        ['node_3', 'node_6'],
        ['node_4', 'node_6'],
    ]), []);



    const difyYamlPlan = useMemo(() => {
        const nodesYaml = plannedSkills.map((item) => [
            `  - id: ${item.id}`,
            '    data:',
            '      type: custom',
            `      title: "${item.skillName}"`,
            `      desc: "${item.output}"`,
            `      skill: "${item.route}"`,
            '      selected: false',
            '      variables: []',
            '      typeVersion: "1"',
            '    position:',
            `      x: ${nodePositions[item.id].x}`,
            `      y: ${nodePositions[item.id].y}`,
        ].join('\n')).join('\n');

        const edgeYaml = edges.map(([source, target]) => [
            `  - id: edge_${source}_${target}`,
            `    source: ${source}`,
            `    target: ${target}`,
            '    type: custom',
            '    data:',
            `      sourceType: ${source}`,
            `      targetType: ${target}`,
        ].join('\n')).join('\n');

        return [
            'app:',
            '  mode: workflow',
            '  name: 설맞이 일일 퀘스트 매출/동접 자동 브리핑',
            'kind: app',
            'version: 0.2.0',
            'workflow:',
            '  conversation_variables: []',
            '  environment_variables:',
            '    - name: REPORT_CRON',
            '      value: "0 9 * * *"',
            '    - name: TARGET_EMAIL',
            '      value: "planning-team@nexon.com"',
            '    - name: TARGET_SLACK_CHANNEL',
            '      value: "#planning-daily"',
            '  graph:',
            '    nodes:',
            nodesYaml,
            '    edges:',
            edgeYaml,
        ].join('\n');
    }, [plannedSkills, nodePositions, edges]);

    const executionLogs = useMemo(() => {
        const startedAt = new Date().toLocaleString('ko-KR');
        return [
            `[${startedAt}] Router 실행 요청 수신`,
            '[master-agent] 분석 기간 확정: 2026-02-13 ~ 2026-02-19, 전날 집계 기준 2026-02-19',
            '[node_0] KPI Planner 완료 -> 쿼리/스케줄/발송 타겟 구성',
            '[parallel-group A:start] node_1(AI 서치 에이전트) + node_2(NEMO RT 에이전트) 동시 실행',
            '[node_1] 일매출 분석 완료 -> 총매출 23.6억(+8.4%), 퀘스트 기여 1.98억',
            '[node_2] 동접 추적 완료 -> 평균 12.4만(+11.7%), 피크 18.2만(+14.2%)',
            '[node_5] 인스턴트 스킬 생성/실행 -> daily_brief_2026-02-19.json',
            '[parallel-group B:start] node_3(Email Summary) + node_4(Slack Notifier) 동시 실행',
            '[node_3] planning-team@nexon.com 전송 완료 (2026-02-20 09:00:02 KST)',
            '[node_4] #planning-daily 전송 완료 (message_ts=1771574402.332100)',
            '[node_6] Delivery Audit 저장 완료 -> delivery_id=DLV-20260220-090001',
            '[router] 전체 워크플로우 상태: SUCCESS',
        ];
    }, []);

    const handleCopyYaml = async () => {
        if (navigator?.clipboard?.writeText) {
            await navigator.clipboard.writeText(difyYamlPlan);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 1800);
        }
    };

    const handleCanvasMouseDown = (e) => {
        if (e.target.closest('[data-node-card="true"]')) return;
        setIsPanning(true);
        panStartRef.current = {
            x: e.clientX - canvasOffset.x,
            y: e.clientY - canvasOffset.y,
        };
    };

    const handleCanvasMouseMove = (e) => {
        if (!isPanning) return;
        setCanvasOffset({
            x: e.clientX - panStartRef.current.x,
            y: e.clientY - panStartRef.current.y,
        });
    };

    const handleCanvasMouseUp = () => {
        if (!isPanning) return;
        setIsPanning(false);
    };

    return (
        <div className="space-y-6 animate-in">
            <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-7 shadow-sm">
                <h2 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
                    AI 실험실
                    <span className="text-xs px-3 py-1 rounded-full bg-violet-50 text-violet-700 border border-violet-200 font-bold">Master Prompt Runtime</span>
                </h2>
                <p className="mt-3 text-slate-600 leading-relaxed">
                    상위 Master Agent가 자연어를 Sub Agents 실행 계획으로 변환한 뒤 Router가 사용할 스킬들을 병렬/순차 혼합으로 소환합니다.
                </p>
            </div>

            <div className="grid grid-cols-1 xl:grid-cols-5 gap-5">
                <div className="xl:col-span-2 space-y-5">
                    <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-5 shadow-sm h-[360px] flex flex-col">
                        <div className="flex items-center gap-2 text-slate-800 font-bold"><Sparkles size={18}/> 1) 입력 (Master Prompt)</div>
                        <textarea
                            value={masterPrompt}
                            onChange={(e) => setMasterPrompt(e.target.value)}
                            className="mt-3 flex-1 w-full border-2 border-slate-200 rounded-2xl p-4 text-sm focus:outline-none focus:border-violet-500"
                        />
                        <button
                            onClick={() => {
                                setIsAnalyzed(true);
                                setIsRan(false);
                            }}
                            className="mt-3 w-full game-btn bg-slate-800 text-white py-3 rounded-2xl font-bold hover:bg-slate-900 transition-colors"
                        >
                            프롬프트 분석
                        </button>
                        <p className="mt-3 text-xs text-slate-500">예시: "설맞이 일일 퀘스트 성과를 매일 9시에 메일/슬랙으로 공유해줘."</p>
                    </div>

                    <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-5 shadow-sm h-[360px] flex flex-col">
                        <div className="flex items-center justify-between gap-3">
                            <div className="flex items-center gap-2 text-slate-800 font-bold"><Bot size={18}/> 2) 프롬프트 분석 결과 (Dify)</div>
                            <button
                                type="button"
                                onClick={handleCopyYaml}
                                className="px-3 py-2 text-xs font-bold rounded-xl border border-slate-200 text-slate-700 hover:border-violet-300 hover:text-violet-700 transition-colors inline-flex items-center gap-2"
                            >
                                <Clipboard size={14}/>
                                {isCopied ? '복사됨' : '클립보드 복사'}
                            </button>
                        </div>
                        <pre className="mt-3 flex-1 bg-slate-900 text-slate-100 text-xs rounded-2xl p-4 overflow-x-auto whitespace-pre-wrap">{difyYamlPlan}</pre>
                    </div>
                </div>

                <div className="xl:col-span-3 bg-white border-2 border-slate-200 rounded-[2rem] p-5 shadow-sm h-[740px] flex flex-col">
                    <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                        <div className="flex items-center gap-2 text-slate-800 font-bold"><Workflow size={18}/> 3) 스킬 실행 계획 (시뮬레이션)</div>
                        <div className="flex flex-col sm:flex-row gap-2">
                            <button
                                onClick={() => {
                                    setIsAnalyzed(true);
                                    setIsRan(true);
                                }}
                                className="w-full md:w-auto game-btn bg-violet-600 text-white py-3 px-6 rounded-2xl font-bold hover:bg-violet-700 transition-colors flex items-center justify-center gap-2"
                            >
                                <PlayCircle size={18}/> 초안 실행
                            </button>
                            <button
                                onClick={() => setIsLogOpen(true)}
                                className="w-full md:w-auto game-btn bg-slate-100 text-slate-800 py-3 px-6 rounded-2xl font-bold hover:bg-slate-200 transition-colors flex items-center justify-center gap-2 border border-slate-200"
                            >
                                <FileText size={18}/> 결과 확인
                            </button>
                        </div>
                    </div>
                    <div
                        className={`mt-3 p-4 border border-slate-200 rounded-2xl bg-gradient-to-b from-slate-50 to-violet-50/40 flex-1 min-h-0 overflow-hidden ${isPanning ? 'cursor-grabbing' : 'cursor-grab'}`}
                        onMouseDown={handleCanvasMouseDown}
                        onMouseMove={handleCanvasMouseMove}
                        onMouseUp={handleCanvasMouseUp}
                        onMouseLeave={handleCanvasMouseUp}
                    >
                        <div className="text-[11px] font-bold text-slate-500 mb-2">Canvas Preview · Router Graph (조회 전용, 드래그로 이동)</div>
                        <div className="relative w-full h-[560px] border border-violet-100 rounded-2xl bg-white/80 overflow-hidden">
                            <div className="absolute inset-0 bg-[radial-gradient(circle,_rgba(148,163,184,0.14)_1px,_transparent_1px)] [background-size:18px_18px]"/>
                            <div className="absolute left-0 top-0 w-[1560px] h-[420px]" style={{ transform: `translate(${canvasOffset.x}px, ${canvasOffset.y}px)` }}>
                                <svg className="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 1560 420" fill="none">
                                    {edges.map(([source, target]) => {
                                        const sourcePos = nodePositions[source];
                                        const targetPos = nodePositions[target];
                                        if (!sourcePos || !targetPos) return null;
                                        const startX = sourcePos.x + 240;
                                        const startY = sourcePos.y + 52;
                                        const endX = targetPos.x;
                                        const endY = targetPos.y + 52;
                                        const controlOffset = Math.max(90, (endX - startX) * 0.45);
                                        return (
                                            <path
                                                key={`${source}-${target}`}
                                                d={`M ${startX} ${startY} C ${startX + controlOffset} ${startY}, ${endX - controlOffset} ${endY}, ${endX} ${endY}`}
                                                stroke="#8B5CF6"
                                                strokeWidth="2.5"
                                                strokeOpacity="0.5"
                                            />
                                        );
                                    })}
                                </svg>
                                {plannedSkills.map((item, idx) => {
                                    const position = nodePositions[item.id];
                                    if (!position) return null;
                                    return (
                                        <button
                                            key={item.id}
                                            data-node-card="true"
                                            type="button"
                                            onClick={() => setSelectedNode(item)}
                                            className="absolute text-left border-2 border-violet-200 rounded-2xl p-4 bg-white w-[240px] shadow-sm hover:shadow-md hover:border-violet-300 transition-all"
                                            style={{ left: `${position.x}px`, top: `${position.y}px` }}
                                        >
                                            <div className="absolute -top-2 left-4 px-2 py-0.5 rounded-md bg-violet-100 text-violet-700 text-[10px] font-black">NODE {idx + 1}</div>
                                            <div className="mt-2 flex items-center justify-between">
                                                <div className="font-semibold text-slate-800 text-sm">{item.skillName}</div>
                                                <div className="w-3 h-3 rounded-full bg-emerald-400 border-2 border-emerald-100"/>
                                            </div>
                                            <div className="text-xs text-slate-500 mt-2 truncate">{item.route}</div>
                                            <div className="mt-3 inline-flex items-center gap-1 text-[11px] font-bold text-violet-700 bg-violet-50 border border-violet-200 px-2 py-1 rounded-lg">
                                                <Braces size={12}/> {item.skill}
                                            </div>
                                            <div className="mt-2 text-[11px] text-slate-500 truncate">output: {item.output}</div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                    <div className="mt-4">
                        {isAnalyzed && !isRan && <div className="text-xs font-bold text-blue-700 bg-blue-50 border border-blue-200 rounded-xl px-3 py-2 inline-flex items-center gap-2"><Check size={14}/> 워크플로우 분석이 완료되었습니다.</div>}
                        {isRan && <div className="text-xs font-bold text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-xl px-3 py-2 inline-flex items-center gap-2"><Check size={14}/> 초안 실행 결과가 갱신되었습니다.</div>}
                    </div>
                </div>
            </div>

            {isLogOpen && (
                <div className="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center px-4">
                    <div className="w-full max-w-3xl bg-white border-2 border-slate-200 rounded-3xl shadow-xl">
                        <div className="flex items-center justify-between p-5 border-b border-slate-200">
                            <div>
                                <h3 className="text-lg font-bold text-slate-900">Router 실행 결과 로그</h3>
                                <p className="text-xs text-slate-500 mt-1">실제 값 기반의 단계별 실행 로그입니다.</p>
                            </div>
                            <button
                                type="button"
                                onClick={() => setIsLogOpen(false)}
                                className="w-9 h-9 rounded-xl border border-slate-200 text-slate-500 hover:text-slate-900 hover:border-slate-300 flex items-center justify-center"
                            >
                                <X size={16}/>
                            </button>
                        </div>
                        <div className="p-5 space-y-3 max-h-[420px] overflow-y-auto">
                            {executionLogs.map((line, idx) => (
                                <div key={line + idx} className="text-xs rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 font-mono text-slate-700">
                                    {line}
                                </div>
                            ))}
                        </div>
                        <div className="px-5 pb-5 flex justify-end">
                            <button
                                type="button"
                                onClick={() => setIsLogOpen(false)}
                                className="game-btn bg-slate-800 text-white py-2.5 px-5 rounded-2xl font-bold hover:bg-slate-900 transition-colors"
                            >
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {selectedNode && (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4" onClick={() => setSelectedNode(null)}>
                    <div className="bg-white rounded-[32px] shadow-2xl w-full max-w-2xl overflow-hidden relative border-4 border-slate-900" onClick={(e) => e.stopPropagation()}>
                        <div className="flex items-start justify-between p-6 border-b border-slate-200 bg-slate-50">
                            <div>
                                <div className="text-xs font-bold text-violet-700">{selectedNode.id}</div>
                                <h3 className="text-2xl font-bold text-slate-900 mt-1">{selectedNode.skillName}</h3>
                                <p className="text-sm text-slate-500 mt-1">{selectedNode.originLabel}</p>
                            </div>
                            <button
                                type="button"
                                onClick={() => setSelectedNode(null)}
                                className="w-10 h-10 rounded-xl border border-slate-200 text-slate-500 hover:text-slate-900 hover:border-slate-300 flex items-center justify-center"
                            >
                                <X size={16}/>
                            </button>
                        </div>
                        <div className="p-6 space-y-4 text-sm">
                            <div className="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                                <div className="text-xs font-semibold text-slate-500">실행 스킬 ID</div>
                                <div className="mt-1 font-mono text-slate-800">{selectedNode.skill}</div>
                            </div>
                            <div className="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                                <div className="text-xs font-semibold text-slate-500">라우팅 경로</div>
                                <div className="mt-1 font-mono text-slate-800 break-all">{selectedNode.route}</div>
                            </div>
                            <div className="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                                <div className="text-xs font-semibold text-slate-500">노드 설명</div>
                                <div className="mt-1 text-slate-700">{selectedNode.detail}</div>
                            </div>
                            <div className="rounded-xl border border-violet-200 bg-violet-50 px-4 py-3">
                                <div className="text-xs font-semibold text-violet-700">최근 출력</div>
                                <div className="mt-1 text-violet-900 font-semibold">{selectedNode.output}</div>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

window.AppComponents.AIStudio = AIStudio;
