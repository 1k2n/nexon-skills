const { useState, useEffect, useRef } = window.React;
const { Database, Box, MessageSquare, Check, Plus, Settings, Mic, ArrowRight, Image, Video, Maximize2, X, Sparkles } = window.LucideReact;

const AIStudio = () => {
            const [activeMode, setActiveMode] = useState('text');
            const [connectedTools, setConnectedTools] = useState([]);
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([ { id: 1, role: 'user', type: 'text', content: '이 제품 디자인의 개선점을 분석하고, 더 모던한 스타일로 변형해줘.', hasImage: true }, { id: 2, role: 'ai', type: 'text', content: '업로드하신 디자인은 미니멀하지만, 색상 대비가 부족하여 시인성이 낮습니다. 다음과 같이 개선을 제안합니다:\n\n• 메인 액션 버튼에 강조색(Accent Color) 적용\n• 모서리 라운딩(Radius)을 24px로 증가\n• 그림자(Shadow) 심도를 낮춰 플랫한 느낌 강화\n\n제안 사항을 반영하여 생성한 시안입니다.', hasResultImage: true } ]);
            const [isTyping, setIsTyping] = useState(false);
            const chatScrollRef = useRef(null);
            const availableConnectors = [ { id: 'c1', name: 'Nexon User API', type: 'Private API', icon: Database }, { id: 'c2', name: 'Maple Inventory', type: 'Sandbox API', icon: Box }, { id: 'c3', name: 'Slack Notifier', type: 'MCP', icon: MessageSquare } ];
            const toggleTool = (tool) => { if (connectedTools.some(t => t.id === tool.id)) { setConnectedTools(prev => prev.filter(t => t.id !== tool.id)); } else { setConnectedTools(prev => [...prev, tool]); } };
            useEffect(() => {
                if (!chatScrollRef.current) return;
                chatScrollRef.current.scrollTop = chatScrollRef.current.scrollHeight;
            }, [messages, isTyping]);
            const modeConfig = {
                text: {
                    title: '텍스트 대화',
                    description: '질문을 입력하면 바로 대화를 시작합니다.',
                    placeholder: "메시지를 입력하거나 '/'를 눌러 명령어를 실행하세요...",
                    actions: [ { label: '이미지 생성', icon: Image }, { label: '비디오 분석', icon: Video } ]
                },
                image: {
                    title: '이미지 작업',
                    description: '생성, 편집, 스타일 변환 요청에 최적화된 대화창입니다.',
                    placeholder: '원하는 이미지 스타일이나 수정 요청을 입력하세요...',
                    actions: [ { label: '이미지 업로드', icon: Image }, { label: '스타일 프리셋', icon: Settings } ]
                },
                video: {
                    title: '비디오 분석',
                    description: '요약, 장면 분할, 하이라이트 추출에 맞춘 대화창입니다.',
                    placeholder: '분석할 비디오 링크나 목표를 입력하세요...',
                    actions: [ { label: '비디오 업로드', icon: Video }, { label: '하이라이트 추출', icon: Sparkles } ]
                }
            };
            const activeConfig = modeConfig[activeMode];
            const handleSend = () => { if (!input.trim()) return; const userMsg = { id: Date.now(), role: 'user', type: activeMode, content: input }; setMessages(prev => [...prev, userMsg]); setInput(''); setIsTyping(true); setTimeout(() => { const aiMsg = { id: Date.now() + 1, role: 'ai', type: activeMode, content: `"${userMsg.content}"에 대한 요청을 처리했습니다.\n추가적인 수정 사항이 있으신가요?` }; setMessages(prev => [...prev, aiMsg]); setIsTyping(false); }, 1500); };
            const handleKeyDown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } };

            return (
                <div className="space-y-6 animate-in h-auto lg:h-[calc(100vh-200px)] flex flex-col">
                    <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-white p-6 rounded-[2rem] border-2 border-slate-200 shadow-sm gap-6">
                        <div className="flex items-center gap-4"><h2 className="text-2xl font-bold text-slate-900 flex items-center gap-3">AI 실험실 <span className="hidden sm:inline text-sm font-bold text-slate-400 px-3 border-l-2 border-slate-200 uppercase tracking-widest">Multimodal Sandbox</span></h2></div>
                        <div className="flex flex-col sm:flex-row gap-3 w-full sm:w-auto"><div className="flex bg-slate-100 p-1.5 rounded-xl w-full sm:w-auto border border-slate-200">{['text', 'image', 'video'].map(m => (<button key={m} onClick={() => setActiveMode(m)} className={`flex-1 sm:flex-none px-5 py-2 rounded-lg text-sm font-bold capitalize transition-all ${activeMode === m ? 'bg-white text-blue-600 shadow-sm scale-105' : 'text-slate-400 hover:text-slate-600'}`}>{m}</button>))}</div><div className="hidden sm:block h-full w-[2px] bg-slate-100 mx-2"></div><select className="bg-slate-50 border-2 border-slate-200 rounded-xl px-5 py-2.5 text-sm font-bold focus:ring-0 focus:border-blue-500 outline-none w-full sm:w-auto text-slate-700 cursor-pointer hover:border-blue-300 transition-colors"><option>Gemini 3 Pro (Multimodal)</option><option>GPT-4o</option><option>Claude 3.6 Opus</option></select></div>
                    </div>
                    <div className="flex-1 flex flex-col lg:flex-row gap-6 overflow-hidden">
                        <div className="w-full lg:w-1/3 flex flex-col gap-4">
                            <div className="bg-white rounded-[2rem] border-2 border-slate-200 flex-none lg:flex-1 flex flex-col shadow-sm overflow-hidden min-h-[200px]"><div className="p-5 border-b-2 border-slate-100 flex justify-between items-center bg-slate-50"><span className="text-xs font-bold uppercase text-slate-400 flex items-center gap-2 tracking-wide"><Settings size={14}/> 시스템 프롬프트</span></div><textarea className="flex-1 p-5 text-sm focus:outline-none resize-none leading-relaxed text-slate-600 h-32 lg:h-auto font-medium" placeholder="AI의 역할과 행동 지침을 정의하세요..." defaultValue="당신은 시각적 데이터를 분석하고 창의적인 솔루션을 제안하는 멀티모달 AI 전문가입니다."></textarea></div>
                            <div className="bg-white rounded-[2rem] border-2 border-slate-200 p-5 shadow-sm flex-none lg:flex-1 flex flex-col overflow-hidden min-h-[200px]">
                                <div className="text-xs font-bold uppercase text-slate-400 mb-4 flex items-center gap-2 flex-shrink-0 tracking-wide"><Database size={14}/> 스킬 불러오기 (내 커넥터)</div>
                                <div className="flex-1 overflow-y-auto space-y-3 pr-1 h-32 lg:h-auto">{availableConnectors.map((tool, i) => { const isConnected = connectedTools.some(t => t.id === tool.id); const Icon = tool.icon; return (<div key={tool.id} onClick={() => toggleTool(tool)} className={`p-4 rounded-2xl border-2 cursor-pointer transition-all flex items-center justify-between group ${isConnected ? 'bg-blue-50 border-blue-500 shadow-md' : 'bg-white border-slate-100 hover:border-blue-300 hover:shadow-md'}`}><div className="flex items-center gap-3"><div className={`p-2.5 rounded-xl border-2 ${isConnected ? 'bg-blue-100 text-blue-600 border-blue-200' : 'bg-slate-50 text-slate-400 border-slate-100 group-hover:bg-blue-50 group-hover:text-blue-500 group-hover:border-blue-100'}`}><Icon size={18} strokeWidth={2.5} /></div><div><div className={`text-sm font-bold ${isConnected ? 'text-blue-900' : 'text-slate-700'}`}>{tool.name}</div><div className="text-[10px] text-slate-400 font-bold">{tool.type}</div></div></div><div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all border-2 ${isConnected ? 'bg-blue-500 text-white border-blue-600' : 'bg-slate-100 text-slate-300 border-slate-200 group-hover:border-blue-300 group-hover:text-blue-400'}`}>{isConnected ? <Check size={16} strokeWidth={4} /> : <Plus size={16} strokeWidth={4} />}</div></div>) })}</div>
                                {connectedTools.length > 0 && (<div className="mt-4 pt-4 border-t-2 border-slate-100 flex-shrink-0"><div className="text-[10px] font-bold text-slate-300 mb-3 uppercase tracking-wide">연결됨</div><div className="flex flex-wrap gap-2">{connectedTools.map(t => (<span key={t.id} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-xl text-xs font-bold animate-in border border-blue-200">{t.name}<button onClick={(e) => { e.stopPropagation(); toggleTool(t); }} className="hover:bg-blue-200 rounded-full p-0.5"><X size={12} strokeWidth={3} /></button></span>))}</div></div>)}
                            </div>
                        </div>
                        <div className="w-full lg:flex-1 bg-slate-100 rounded-[2rem] border-2 border-slate-200 flex flex-col shadow-inner overflow-hidden relative min-h-[500px]">
                             <div ref={chatScrollRef} className="flex-1 p-6 space-y-8 overflow-y-auto no-scrollbar">
                                {activeMode !== 'text' && (
                                    <div className="bg-white border-2 border-slate-200 rounded-3xl p-6 shadow-sm flex flex-col gap-4">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center border border-blue-100">
                                                {activeMode === 'image' ? <Image size={20} /> : <Video size={20} />}
                                            </div>
                                            <div>
                                                <div className="text-sm font-bold text-slate-900">{activeConfig.title}</div>
                                                <div className="text-xs text-slate-500 font-medium">{activeConfig.description}</div>
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {activeConfig.actions.map(action => (
                                                <button key={action.label} className="text-xs font-bold text-slate-600 hover:text-slate-900 flex items-center gap-1.5 bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200 hover:border-slate-300 transition-colors">
                                                    <action.icon size={14} /> {action.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {messages.map((msg, index) => (
                                    <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-in`}>
                                        <div className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'} gap-2 max-w-[85%]`}>
                                            {msg.role === 'ai' && (<div className="flex items-center gap-2 mb-1"><div className="w-8 h-8 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-[10px] font-bold border-2 border-white shadow-sm">AI</div><span className="text-xs font-bold text-slate-500">Gemini</span></div>)}
                                            {msg.hasImage && (<div className="bg-white p-2 rounded-2xl border-2 border-slate-200 shadow-sm"><div className="w-48 h-32 bg-slate-100 rounded-xl flex items-center justify-center text-slate-300 mb-2 border-2 border-dashed border-slate-200"><Image size={32}/></div></div>)}
                                            <div className={`px-6 py-4 rounded-[20px] text-sm shadow-sm whitespace-pre-wrap font-medium leading-relaxed ${msg.role === 'user' ? 'bg-slate-900 text-white rounded-tr-none shadow-[0px_4px_0px_rgba(0,0,0,0.1)]' : 'bg-white border-2 border-slate-200 text-slate-700 rounded-tl-none shadow-[0px_4px_0px_#e2e8f0]'}`}>
                                                {msg.content}
                                            </div>
                                            {msg.hasResultImage && (<div className="bg-white p-3 rounded-3xl border-2 border-slate-200 shadow-sm mt-2 group cursor-pointer relative overflow-hidden hover:scale-[1.02] transition-transform"><div className="w-72 h-48 bg-gradient-to-br from-indigo-50 to-blue-50 rounded-2xl flex items-center justify-center border-2 border-slate-100"><svg viewBox="0 0 100 100" className="w-full h-full p-8 opacity-50"><rect x="20" y="20" width="60" height="60" rx="16" fill="#4F46E5" opacity="0.2"/><circle cx="70" cy="30" r="5" fill="#4F46E5"/><rect x="30" y="40" width="40" height="6" rx="3" fill="#4F46E5" opacity="0.6"/><rect x="30" y="54" width="30" height="6" rx="3" fill="#4F46E5" opacity="0.4"/><rect x="30" y="70" width="20" height="8" rx="4" fill="#4F46E5"/></svg></div><div className="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100"><div className="bg-white/90 p-3 rounded-full shadow-lg backdrop-blur-sm"><Maximize2 className="text-slate-900" size={24}/></div></div></div>)}
                                        </div>
                                    </div>
                                ))}
                                {isTyping && (<div className="flex justify-start animate-in fade-in"><div className="flex flex-col items-start gap-2"><div className="flex items-center gap-2 mb-1"><div className="w-8 h-8 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-[10px] font-bold border-2 border-white shadow-sm">AI</div><span className="text-xs font-bold text-slate-500">Gemini</span></div><div className="bg-white border-2 border-slate-200 px-5 py-4 rounded-[20px] rounded-tl-none text-sm shadow-sm flex items-center gap-1.5"><div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div><div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div><div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div></div></div></div>)}
                             </div>
                             <div className="p-5 bg-white border-t-2 border-slate-200">
                                <div className="relative"><textarea rows="1" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={handleKeyDown} className="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl pl-5 pr-14 py-4 text-sm focus:outline-none focus:border-blue-500 focus:bg-white resize-none font-medium transition-all shadow-inner" placeholder={activeConfig.placeholder}></textarea><div className="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-2"><button className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors"><Mic size={20}/></button><button onClick={handleSend} className="p-2 bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition-colors shadow-md hover:scale-105 active:scale-95"><ArrowRight size={20} strokeWidth={3}/></button></div></div>
                                <div className="flex items-center gap-4 mt-4 px-2">
                                    {activeConfig.actions.map(action => (
                                        <button key={action.label} className="text-xs font-bold text-slate-500 hover:text-slate-900 flex items-center gap-1.5 bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200 hover:border-slate-300 transition-colors">
                                            <action.icon size={14} /> {action.label}
                                        </button>
                                    ))}
                                    <div className="flex-1"></div><span className="text-[10px] text-slate-300 font-bold uppercase tracking-wide">Shift + Enter for new line</span>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            );
        };

window.AppComponents.AIStudio = AIStudio;
