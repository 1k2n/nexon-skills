const { useState, useRef, useEffect, useCallback } = window.React;
const { Database, Box, MessageSquare, Check, Plus, Settings, X, Search, Bot, Cpu, Eye, Download, Play, Code, Layers, FileText, Globe, Terminal, Sparkles, ChevronRight, Copy, Table, BarChart, Image, FileDown, Monitor, Puzzle, Shield, Thermometer, Lightbulb } = window.LucideReact;

const AIStudio = () => {
    const [selectedConnectors, setSelectedConnectors] = useState([]);
    const [selectedPlugins, setSelectedPlugins] = useState([]);
    const [agentName, setAgentName] = useState('My Custom Agent');
    const [agentInstructions, setAgentInstructions] = useState('ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ì„í•˜ê³ , ì—°ê²°ëœ ì»¤ë„¥í„°ì™€ í”ŒëŸ¬ê·¸ì¸ì„ í™œìš©í•˜ì—¬ ìµœì ì˜ ê²°ê³¼ë¥¼ ì œê³µí•˜ëŠ” AI ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤.');
    const [selectedModel, setSelectedModel] = useState('gemini-3-pro');
    const [searchQuery, setSearchQuery] = useState('');
    const [activeFilter, setActiveFilter] = useState('ì „ì²´');
    const [activeTab, setActiveTab] = useState('connectors');
    const [showPreview, setShowPreview] = useState(false);
    const [copied, setCopied] = useState(false);
    const [svgLines, setSvgLines] = useState([]);

    /* ---- New config states ---- */
    const [outputFormat, setOutputFormat] = useState('markdown');
    const [temperature, setTemperature] = useState(0.7);
    const [guardrails, setGuardrails] = useState([]);
    const [examples, setExamples] = useState(['']);

    const canvasRef = useRef(null);
    const cardRefs = useRef({});
    const agentNodeRef = useRef(null);

    /* ---- Data ---- */
    const allConnectors = [
        { id: 'c1', name: 'Nexon User API', type: 'Private API', icon: Database, endpt: '/api/v1/user', desc: 'ë„¥ìŠ¨ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ' },
        { id: 'c2', name: 'Maple Inventory', type: 'Sandbox API', icon: Box, endpt: '/sandbox/maple/inv', desc: 'ë©”ì´í”Œ ì¸ë²¤í† ë¦¬' },
        { id: 'c3', name: 'Slack Notifier', type: 'MCP', icon: MessageSquare, endpt: 'mcp://slack-bot', desc: 'ìŠ¬ë™ ë©”ì‹œì§€ ì „ì†¡' },
        { id: 'c4', name: 'Internal Wiki RAG', type: 'RAG', icon: FileText, endpt: 'vec://wiki-prod', desc: 'ì‚¬ë‚´ ìœ„í‚¤ ê²€ìƒ‰' },
        { id: 'c5', name: 'Global Weather', type: 'Public API', icon: Globe, endpt: 'api.weather.com', desc: 'ë‚ ì”¨ ì •ë³´ ì¡°íšŒ' },
        { id: 'c6', name: 'Server Restart', type: 'NXCommand', icon: Terminal, endpt: 'cmd://restart-server', desc: 'ì„œë²„ ì¬ì‹œì‘' },
    ];

    const builtinPlugins = [
        { id: 'p1', name: 'PDF ë¬¸ì„œ ìƒì„±', type: 'Document', icon: FileText, desc: 'PDF íŒŒì¼ ë™ì  ìƒì„± ë° ë‹¤ìš´ë¡œë“œ', capability: 'pdf-generation' },
        { id: 'p2', name: 'XLSX ìŠ¤í”„ë ˆë“œì‹œíŠ¸', type: 'Spreadsheet', icon: Table, desc: 'Excel íŒŒì¼ ìƒì„±Â·í¸ì§‘Â·ë‚´ë³´ë‚´ê¸°', capability: 'xlsx-generation' },
        { id: 'p3', name: 'PPTX í”„ë ˆì  í…Œì´ì…˜', type: 'Presentation', icon: Monitor, desc: 'PowerPoint ìŠ¬ë¼ì´ë“œ ìë™ ìƒì„±', capability: 'pptx-generation' },
        { id: 'p4', name: 'CSV ë°ì´í„° ë³€í™˜', type: 'Data', icon: FileDown, desc: 'êµ¬ì¡°í™” ë°ì´í„°ë¥¼ CSVë¡œ ë³€í™˜Â·ë‚´ë³´ë‚´ê¸°', capability: 'csv-export' },
        { id: 'p5', name: 'ì´ë¯¸ì§€ ìƒì„±', type: 'Media', icon: Image, desc: 'AI ê¸°ë°˜ ì´ë¯¸ì§€ ìƒì„± ë° í¸ì§‘', capability: 'image-generation' },
        { id: 'p6', name: 'ì°¨íŠ¸ ì‹œê°í™”', type: 'Visualization', icon: BarChart, desc: 'ë°ì´í„° ì°¨íŠ¸Â·ê·¸ë˜í”„ ìë™ ìƒì„±', capability: 'chart-visualization' },
    ];

    const models = [
        { id: 'gemini-3-pro', name: 'Gemini 3 Pro', vendor: 'Google', emoji: 'âœ¨' },
        { id: 'gpt-4o', name: 'GPT-4o', vendor: 'OpenAI', emoji: 'ğŸŸ¢' },
        { id: 'claude-3.6-opus', name: 'Claude 3.6 Opus', vendor: 'Anthropic', emoji: 'ğŸ§ ' },
        { id: 'cortex-llama', name: 'Cortex Llama', vendor: 'Snowflake', emoji: 'â„ï¸' },
    ];

    const outputFormats = [
        { id: 'markdown', label: 'Markdown' },
        { id: 'json', label: 'JSON' },
        { id: 'html', label: 'HTML' },
        { id: 'plain', label: 'Plain Text' },
        { id: 'table', label: 'í‘œ (Table)' },
        { id: 'free', label: 'ììœ  í˜•ì‹' },
    ];

    const guardrailOptions = [
        'ê°œì¸ì •ë³´ ë³´í˜¸', 'ë¹„ì†ì–´ ê¸ˆì§€', 'ì™¸ë¶€ URL ì°¨ë‹¨',
        'ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹', 'ì •ì¹˜ì  ì¤‘ë¦½', 'ê¸ˆìœµ ì¡°ì–¸ ê¸ˆì§€',
    ];

    const typeFilters = ['ì „ì²´', 'Private API', 'Sandbox API', 'MCP', 'RAG', 'Public API', 'NXCommand'];
    const currentModel = models.find(m => m.id === selectedModel);
    const currentFormat = outputFormats.find(f => f.id === outputFormat);

    const filteredConnectors = allConnectors.filter(c =>
        (activeFilter === 'ì „ì²´' || c.type === activeFilter) &&
        c.name.toLowerCase().includes(searchQuery.toLowerCase())
    );

    /* ---- Handlers ---- */
    const toggleConnector = (connector) => {
        setSelectedConnectors(prev =>
            prev.some(c => c.id === connector.id)
                ? prev.filter(c => c.id !== connector.id)
                : [...prev, connector]
        );
    };

    const togglePlugin = (plugin) => {
        setSelectedPlugins(prev =>
            prev.some(p => p.id === plugin.id)
                ? prev.filter(p => p.id !== plugin.id)
                : [...prev, plugin]
        );
    };

    const toggleGuardrail = (g) => {
        setGuardrails(prev => prev.includes(g) ? prev.filter(x => x !== g) : [...prev, g]);
    };

    const addExample = () => {
        if (examples.length < 3) setExamples([...examples, '']);
    };

    const updateExample = (i, val) => {
        const updated = [...examples];
        updated[i] = val;
        setExamples(updated);
    };

    const removeExample = (i) => {
        if (examples.length > 1) setExamples(examples.filter((_, idx) => idx !== i));
    };

    /* ---- Combined items for canvas ---- */
    const canvasItems = [
        ...selectedConnectors.map(c => ({ ...c, kind: 'connector' })),
        ...selectedPlugins.map(p => ({ ...p, kind: 'plugin' })),
    ];

    /* ---- SVG line calculation from actual DOM positions ---- */
    const updateLines = useCallback(() => {
        const items = [...selectedConnectors, ...selectedPlugins];
        if (!canvasRef.current || !agentNodeRef.current || items.length === 0) {
            setSvgLines([]);
            return;
        }
        const canvasRect = canvasRef.current.getBoundingClientRect();
        const agentRect = agentNodeRef.current.getBoundingClientRect();
        const ex = agentRect.left - canvasRect.left;
        const ey = agentRect.top + agentRect.height / 2 - canvasRect.top;

        const newLines = items.map(item => {
            const el = cardRefs.current[item.id];
            if (!el) return null;
            const rect = el.getBoundingClientRect();
            return {
                sx: rect.right - canvasRect.left,
                sy: rect.top + rect.height / 2 - canvasRect.top,
                ex,
                ey,
                kind: item.id.startsWith('p') ? 'plugin' : 'connector'
            };
        }).filter(Boolean);

        setSvgLines(newLines);
    }, [selectedConnectors, selectedPlugins]);

    useEffect(() => {
        const frame = requestAnimationFrame(updateLines);
        return () => cancelAnimationFrame(frame);
    }, [updateLines, agentName, selectedModel]);

    useEffect(() => {
        window.addEventListener('resize', updateLines);
        return () => window.removeEventListener('resize', updateLines);
    }, [updateLines]);

    /* ---- skill.md generation ---- */
    const connectorYaml = selectedConnectors.map(c =>
        '  - name: "' + c.name + '"\n    type: ' + c.type + '\n    endpoint: "' + c.endpt + '"'
    ).join('\n');

    const pluginYaml = selectedPlugins.map(p =>
        '  - name: "' + p.name + '"\n    type: builtin\n    capability: ' + p.capability
    ).join('\n');

    const guardrailYaml = guardrails.map(g => '  - "' + g + '"').join('\n');

    const validExamples = examples.filter(e => e.trim());
    const exampleYaml = validExamples.map(e => '  - "' + e + '"').join('\n');

    const skillMdContent = [
        '---',
        'name: "' + agentName + '"',
        'type: agent',
        'model: ' + selectedModel,
        'version: 1.0.0',
        'status: draft',
        'output_format: ' + outputFormat,
        'temperature: ' + temperature,
        'connectors:',
        connectorYaml || '  []',
        'plugins:',
        pluginYaml || '  []',
        'guardrails:',
        guardrailYaml || '  []',
        'examples:',
        exampleYaml || '  []',
        '---',
        '',
        '# ' + agentName,
        '',
        '## Agent Instructions',
        '```',
        agentInstructions,
        '```',
        '',
        '## Output Format',
        (currentFormat?.label || 'N/A'),
        '',
        '## Connected Skills',
        ...(selectedConnectors.length > 0
            ? selectedConnectors.map(c => '- **' + c.name + '** (`' + c.type + '`) - `' + c.endpt + '`')
            : ['(ì»¤ë„¥í„° ì—†ìŒ)']),
        '',
        '## Built-in Plugins',
        ...(selectedPlugins.length > 0
            ? selectedPlugins.map(p => '- **' + p.name + '** (`' + p.type + '`) - `' + p.capability + '`')
            : ['(í”ŒëŸ¬ê·¸ì¸ ì—†ìŒ)']),
        '',
        '## Guardrails',
        ...(guardrails.length > 0
            ? guardrails.map(g => '- ' + g)
            : ['(ê°€ë“œë ˆì¼ ì—†ìŒ)']),
        '',
        ...(validExamples.length > 0
            ? ['## Example Prompts', ...validExamples.map((e, i) => (i + 1) + '. "' + e + '"'), '']
            : []),
        '## Model Configuration',
        '| Key | Value |',
        '|-----|-------|',
        '| Model | ' + (currentModel?.name || 'N/A') + ' |',
        '| Vendor | ' + (currentModel?.vendor || 'N/A') + ' |',
        '| Temperature | ' + temperature + ' |',
        '| Output | ' + (currentFormat?.label || 'N/A') + ' |',
        '| Connectors | ' + selectedConnectors.length + 'ê°œ ì—°ê²°ë¨ |',
        '| Plugins | ' + selectedPlugins.length + 'ê°œ í™œì„±í™” |',
        '| Guardrails | ' + guardrails.length + 'ê°œ ì„¤ì •ë¨ |',
    ].join('\n');

    const handleCopy = () => {
        navigator.clipboard.writeText(skillMdContent).catch(() => {});
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };

    return (
        <div className="space-y-5 animate-in">
            {/* skill.md Preview Modal */}
            {showPreview && (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-in" onClick={() => setShowPreview(false)}>
                    <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl overflow-hidden border-4 border-slate-900" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between px-6 py-4 border-b-2 border-slate-100 bg-slate-50">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-purple-100 text-purple-600 rounded-xl border border-purple-200"><Code size={18} strokeWidth={2.5}/></div>
                                <div>
                                    <h3 className="font-bold text-slate-900">skill.md</h3>
                                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Generated Skill Definition</p>
                                </div>
                            </div>
                            <button onClick={() => setShowPreview(false)} className="p-2 hover:bg-slate-200 rounded-xl transition-colors"><X size={20} className="text-slate-400" strokeWidth={3}/></button>
                        </div>
                        <div className="p-6 max-h-[60vh] overflow-y-auto">
                            <pre className="bg-slate-900 text-slate-100 p-6 rounded-2xl text-sm font-mono leading-relaxed whitespace-pre-wrap border-2 border-slate-800">{skillMdContent}</pre>
                        </div>
                        <div className="px-6 py-4 border-t-2 border-slate-100 bg-slate-50 flex justify-end gap-3">
                            <button onClick={handleCopy} className="px-5 py-2.5 text-sm font-bold text-slate-600 hover:text-slate-900 hover:bg-slate-200 rounded-xl transition-colors flex items-center gap-2 border border-slate-200">
                                {copied ? <><Check size={16}/> ë³µì‚¬ë¨</> : <><Copy size={16}/> ë³µì‚¬í•˜ê¸°</>}
                            </button>
                            <button className="px-5 py-2.5 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-xl transition-colors shadow-sm flex items-center gap-2"><Download size={16}/> ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Header */}
            <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between bg-white p-6 rounded-[2rem] border-2 border-slate-200 shadow-sm gap-4">
                <div className="flex flex-col gap-2">
                    <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-3">
                        AI ì‹¤í—˜ì‹¤
                        <span className="hidden sm:inline text-sm font-bold text-slate-400 px-3 border-l-2 border-slate-200 uppercase tracking-widest">Skill Experiment Lab</span>
                    </h2>
                    <p className="text-sm text-slate-500 font-medium">ì»¤ë„¥í„°ì™€ ê¸°ë³¸ í”ŒëŸ¬ê·¸ì¸ì„ ì¡°í•©í•˜ê³ , LLMê³¼ ê²°í•©ëœ ì—ì´ì „íŠ¸ë¥¼ ì‹¤í—˜ ì œì‘í•©ë‹ˆë‹¤.</p>
                </div>
                <div className="flex gap-3 w-full lg:w-auto">
                    <button onClick={() => setShowPreview(true)} className="game-btn flex-1 lg:flex-none flex items-center justify-center gap-2 px-5 py-3 bg-slate-900 text-white rounded-2xl text-sm font-bold hover:bg-slate-800 transition-all shadow-[0px_4px_0px_#000] active:shadow-none active:translate-y-[4px]">
                        <Eye size={18}/> skill.md ë¯¸ë¦¬ë³´ê¸°
                    </button>
                    <button className="game-btn flex-1 lg:flex-none flex items-center justify-center gap-2 px-5 py-3 bg-blue-600 text-white rounded-2xl text-sm font-bold hover:bg-blue-700 transition-all shadow-[0px_4px_0px_#1e40af] active:shadow-none active:translate-y-[4px]">
                        <Play size={18}/> í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                    </button>
                </div>
            </div>

            {/* Main grid layout */}
            <div className="flex flex-col gap-5 lg:grid lg:gap-4" style={{gridTemplateColumns: '300px 1fr 340px', gridTemplateRows: '1fr auto'}}>

                {/* Left: Skill Browser (Connectors + Plugins) â€“ spans both rows */}
                <div className="bg-white rounded-[2rem] border-2 border-slate-200 shadow-sm flex flex-col overflow-hidden" style={{gridRow: '1 / -1'}}>
                    {/* Tabs */}
                    <div className="flex border-b-2 border-slate-100 flex-shrink-0">
                        <button onClick={() => setActiveTab('connectors')} className={`flex-1 py-3.5 text-xs font-bold flex items-center justify-center gap-1.5 transition-all border-b-2 -mb-[2px] ${activeTab === 'connectors' ? 'text-blue-600 border-blue-600 bg-blue-50/50' : 'text-slate-400 border-transparent hover:text-slate-600'}`}>
                            <Database size={13}/>
                            <span>ì»¤ë„¥í„°</span>
                            {selectedConnectors.length > 0 && <span className="bg-blue-500 text-white text-[9px] px-1.5 py-0.5 rounded-full font-bold min-w-[18px] text-center leading-none">{selectedConnectors.length}</span>}
                        </button>
                        <button onClick={() => setActiveTab('plugins')} className={`flex-1 py-3.5 text-xs font-bold flex items-center justify-center gap-1.5 transition-all border-b-2 -mb-[2px] ${activeTab === 'plugins' ? 'text-emerald-600 border-emerald-600 bg-emerald-50/50' : 'text-slate-400 border-transparent hover:text-slate-600'}`}>
                            <Puzzle size={13}/>
                            <span>ê¸°ë³¸ í”ŒëŸ¬ê·¸ì¸</span>
                            {selectedPlugins.length > 0 && <span className="bg-emerald-500 text-white text-[9px] px-1.5 py-0.5 rounded-full font-bold min-w-[18px] text-center leading-none">{selectedPlugins.length}</span>}
                        </button>
                    </div>

                    {activeTab === 'connectors' ? (
                        <>
                            <div className="p-5 border-b-2 border-slate-100 bg-slate-50 flex-shrink-0">
                                <div className="text-xs font-bold uppercase text-slate-400 tracking-wide flex items-center gap-2 mb-3"><Database size={14}/> ì»¤ë„¥í„° ë¶ˆëŸ¬ì˜¤ê¸°</div>
                                <div className="relative">
                                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-300" size={16}/>
                                    <input type="text" className="w-full pl-9 pr-3 py-2.5 border-2 border-slate-200 rounded-xl text-xs focus:outline-none focus:border-blue-500 font-medium transition-colors bg-white" placeholder="ì»¤ë„¥í„° ê²€ìƒ‰..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)}/>
                                </div>
                            </div>
                            <div className="px-4 pt-3 flex-shrink-0">
                                <div className="flex flex-wrap gap-1.5 pb-2">
                                    {typeFilters.map(f => (
                                        <button key={f} onClick={() => setActiveFilter(f)} className={`px-2.5 py-1.5 rounded-lg text-[10px] font-bold whitespace-nowrap transition-all border ${activeFilter === f ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}>{f}</button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar">
                                {filteredConnectors.map(connector => {
                                    const isSelected = selectedConnectors.some(c => c.id === connector.id);
                                    const Icon = connector.icon;
                                    return (
                                        <div key={connector.id} onClick={() => toggleConnector(connector)} className={`p-3.5 rounded-2xl border-2 cursor-pointer transition-all flex items-center gap-3 group ${isSelected ? 'bg-blue-50 border-blue-500 shadow-md' : 'bg-white border-slate-100 hover:border-blue-300 hover:shadow-sm'}`}>
                                            <div className={`p-2 rounded-xl border-2 flex-shrink-0 ${isSelected ? 'bg-blue-100 text-blue-600 border-blue-200' : 'bg-slate-50 text-slate-400 border-slate-100 group-hover:bg-blue-50 group-hover:text-blue-500 group-hover:border-blue-100'}`}>
                                                <Icon size={16} strokeWidth={2.5}/>
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className={`text-sm font-bold truncate ${isSelected ? 'text-blue-900' : 'text-slate-700'}`}>{connector.name}</div>
                                                <div className="text-[10px] text-slate-400 font-bold">{connector.type}</div>
                                            </div>
                                            <div className={`w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0 transition-all border-2 ${isSelected ? 'bg-blue-500 text-white border-blue-600' : 'bg-slate-100 text-slate-300 border-slate-200 group-hover:border-blue-300 group-hover:text-blue-400'}`}>
                                                {isSelected ? <Check size={14} strokeWidth={4}/> : <Plus size={14} strokeWidth={4}/>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </>
                    ) : (
                        <>
                            <div className="p-5 border-b-2 border-slate-100 bg-emerald-50/50 flex-shrink-0">
                                <div className="text-xs font-bold uppercase text-emerald-600 tracking-wide flex items-center gap-2 mb-1"><Puzzle size={14}/> ê¸°ë³¸ ì œê³µ í”ŒëŸ¬ê·¸ì¸</div>
                                <p className="text-[11px] text-slate-400 leading-relaxed">Claude Skillsì—ì„œ ê¸°ë³¸ ì œê³µí•˜ëŠ” íŒŒì¼ ìƒì„± ë° ë°ì´í„° ì¶œë ¥ í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.</p>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar">
                                {builtinPlugins.map(plugin => {
                                    const isSelected = selectedPlugins.some(p => p.id === plugin.id);
                                    const Icon = plugin.icon;
                                    return (
                                        <div key={plugin.id} onClick={() => togglePlugin(plugin)} className={`p-3.5 rounded-2xl border-2 cursor-pointer transition-all flex items-center gap-3 group ${isSelected ? 'bg-emerald-50 border-emerald-500 shadow-md' : 'bg-white border-slate-100 hover:border-emerald-300 hover:shadow-sm'}`}>
                                            <div className={`p-2 rounded-xl border-2 flex-shrink-0 ${isSelected ? 'bg-emerald-100 text-emerald-600 border-emerald-200' : 'bg-slate-50 text-slate-400 border-slate-100 group-hover:bg-emerald-50 group-hover:text-emerald-500 group-hover:border-emerald-100'}`}>
                                                <Icon size={16} strokeWidth={2.5}/>
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className={`text-sm font-bold truncate ${isSelected ? 'text-emerald-900' : 'text-slate-700'}`}>{plugin.name}</div>
                                                <div className="text-[10px] text-slate-400 font-bold">{plugin.desc}</div>
                                            </div>
                                            <div className={`w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0 transition-all border-2 ${isSelected ? 'bg-emerald-500 text-white border-emerald-600' : 'bg-slate-100 text-slate-300 border-slate-200 group-hover:border-emerald-300 group-hover:text-emerald-400'}`}>
                                                {isSelected ? <Check size={14} strokeWidth={4}/> : <Plus size={14} strokeWidth={4}/>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </>
                    )}

                    {/* Selected items summary */}
                    {(selectedConnectors.length > 0 || selectedPlugins.length > 0) && (
                        <div className="p-4 border-t-2 border-slate-100 bg-slate-50 flex-shrink-0">
                            <div className="text-[10px] font-bold text-slate-300 mb-2 uppercase tracking-wide">ì„ íƒë¨ ({selectedConnectors.length + selectedPlugins.length})</div>
                            <div className="flex flex-wrap gap-1.5">
                                {selectedConnectors.map(c => (
                                    <span key={c.id} className="inline-flex items-center gap-1 px-2.5 py-1 bg-blue-100 text-blue-700 rounded-lg text-[10px] font-bold border border-blue-200 animate-in">
                                        {c.name}
                                        <button onClick={(e) => { e.stopPropagation(); toggleConnector(c); }} className="hover:bg-blue-200 rounded-full p-0.5"><X size={10} strokeWidth={3}/></button>
                                    </span>
                                ))}
                                {selectedPlugins.map(p => (
                                    <span key={p.id} className="inline-flex items-center gap-1 px-2.5 py-1 bg-emerald-100 text-emerald-700 rounded-lg text-[10px] font-bold border border-emerald-200 animate-in">
                                        {p.name}
                                        <button onClick={(e) => { e.stopPropagation(); togglePlugin(p); }} className="hover:bg-emerald-200 rounded-full p-0.5"><X size={10} strokeWidth={3}/></button>
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}
                </div>

                {/* Center: Canvas */}
                <div ref={canvasRef} className="bg-slate-100 rounded-[2rem] border-2 border-slate-200 shadow-inner overflow-hidden relative min-h-[380px]">
                    <div className="absolute inset-0 opacity-30 pointer-events-none" style={{backgroundImage: 'radial-gradient(#94a3b8 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>

                    <svg className="absolute inset-0 w-full h-full pointer-events-none" style={{zIndex: 5}}>
                        <defs>
                            <linearGradient id="lineGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stopColor="#93c5fd"/>
                                <stop offset="100%" stopColor="#c4b5fd"/>
                            </linearGradient>
                            <linearGradient id="pluginLineGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stopColor="#6ee7b7"/>
                                <stop offset="100%" stopColor="#a7f3d0"/>
                            </linearGradient>
                        </defs>
                        {svgLines.map((line, i) => {
                            const midX = (line.sx + line.ex) / 2;
                            const isPlugin = line.kind === 'plugin';
                            return (
                                <g key={i}>
                                    <path d={'M ' + line.sx + ' ' + line.sy + ' C ' + midX + ' ' + line.sy + ', ' + midX + ' ' + line.ey + ', ' + line.ex + ' ' + line.ey} stroke={isPlugin ? 'url(#pluginLineGrad)' : 'url(#lineGrad)'} strokeWidth="2.5" fill="none" opacity="0.5"/>
                                    <circle cx={line.sx} cy={line.sy} r="3" fill={isPlugin ? '#6ee7b7' : '#93c5fd'}/>
                                </g>
                            );
                        })}
                        {svgLines.length > 0 && <circle cx={svgLines[0].ex} cy={svgLines[0].ey} r="5" fill="#8b5cf6"/>}
                    </svg>

                    {canvasItems.length === 0 ? (
                        <div className="absolute inset-0 flex flex-col items-center justify-center" style={{zIndex: 10}}>
                            <div className="w-20 h-20 bg-white rounded-3xl border-2 border-dashed border-slate-300 flex items-center justify-center mb-4 shadow-sm">
                                <Layers size={32} className="text-slate-300"/>
                            </div>
                            <p className="text-slate-400 font-bold text-lg">ìŠ¤í‚¬ì„ ì¡°í•©í•˜ì„¸ìš”</p>
                            <p className="text-sm text-slate-300 mt-2 text-center px-8 leading-relaxed">ì™¼ìª½ì—ì„œ ì»¤ë„¥í„° ë˜ëŠ” í”ŒëŸ¬ê·¸ì¸ì„ ì„ íƒí•˜ë©´<br/>ì—ì´ì „íŠ¸ì™€ì˜ ì—°ê²°ì´ ì‹œê°í™”ë©ë‹ˆë‹¤</p>
                        </div>
                    ) : (
                        <div className="absolute inset-0 flex items-center justify-center p-6 lg:p-8" style={{zIndex: 10}}>
                            <div className="flex flex-col gap-2.5 flex-shrink-0">
                                {canvasItems.map((item) => {
                                    const Icon = item.icon;
                                    const isPlugin = item.kind === 'plugin';
                                    return (
                                        <div key={item.id} ref={el => { cardRefs.current[item.id] = el; }} className={`bg-white px-4 py-3 rounded-xl border-2 shadow-sm flex items-center gap-2.5 hover:shadow-md transition-all cursor-default ${isPlugin ? 'border-emerald-200 hover:border-emerald-400' : 'border-blue-200 hover:border-blue-400'}`}>
                                            <div className={`p-1.5 rounded-lg border ${isPlugin ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-blue-50 text-blue-600 border-blue-100'}`}>
                                                <Icon size={14} strokeWidth={2.5}/>
                                            </div>
                                            <div>
                                                <div className="text-xs font-bold text-slate-700 leading-tight">{item.name}</div>
                                                <div className="text-[9px] text-slate-400 font-mono">{isPlugin ? item.capability : item.endpt}</div>
                                            </div>
                                            {isPlugin && <span className="text-[7px] font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-200 uppercase tracking-wider">Plugin</span>}
                                        </div>
                                    );
                                })}
                            </div>
                            <div className="w-20 lg:w-40 flex-shrink-0"></div>
                            <div ref={agentNodeRef} className="bg-white p-5 rounded-2xl border-2 border-purple-300 shadow-lg flex-shrink-0 min-w-[160px]">
                                <div className="text-center">
                                    <div className="w-14 h-14 mx-auto bg-gradient-to-br from-purple-500 to-blue-600 rounded-2xl flex items-center justify-center text-white mb-3 shadow-md border-2 border-purple-600">
                                        <Bot size={28}/>
                                    </div>
                                    <div className="font-bold text-slate-900 text-sm">{agentName}</div>
                                    <div className="text-[10px] text-slate-400 font-bold mt-1">{currentModel?.emoji} {currentModel?.name}</div>
                                    <div className="mt-3 pt-3 border-t border-slate-100">
                                        <div className="text-[9px] text-slate-300 uppercase tracking-wider font-bold">ì—°ê²°ëœ ìŠ¤í‚¬</div>
                                        <div className="text-xl font-bold text-purple-600 mt-0.5">{canvasItems.length}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2" style={{zIndex: 10}}>
                        <div className="bg-white/80 backdrop-blur-sm px-4 py-2 rounded-full border border-slate-200 shadow-sm text-[10px] font-bold text-slate-400 uppercase tracking-wide flex items-center gap-2">
                            <Sparkles size={12}/> Skill Composition Canvas
                        </div>
                    </div>
                </div>

                {/* Right top: Agent Name + LLM Model */}
                <div className="flex flex-col gap-4">
                    <div className="bg-white rounded-[2rem] border-2 border-slate-200 p-5 shadow-sm">
                        <div className="text-xs font-bold uppercase text-slate-400 mb-3 tracking-wide flex items-center gap-2"><Bot size={14}/> ì—ì´ì „íŠ¸ ì´ë¦„</div>
                        <input type="text" value={agentName} onChange={(e) => setAgentName(e.target.value)} className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-bold focus:outline-none focus:border-purple-500 transition-colors" placeholder="ì—ì´ì „íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”..."/>
                    </div>
                    <div className="bg-white rounded-[2rem] border-2 border-slate-200 p-5 shadow-sm flex-1">
                        <div className="text-xs font-bold uppercase text-slate-400 mb-3 tracking-wide flex items-center gap-2"><Cpu size={14}/> LLM ëª¨ë¸</div>
                        <div className="space-y-2">
                            {models.map(model => (
                                <button key={model.id} onClick={() => setSelectedModel(model.id)} className={`w-full p-3 rounded-xl border-2 text-left flex items-center gap-3 transition-all ${selectedModel === model.id ? 'bg-purple-50 border-purple-500 shadow-sm' : 'bg-white border-slate-100 hover:border-purple-300'}`}>
                                    <span className="text-lg">{model.emoji}</span>
                                    <div className="flex-1">
                                        <div className={`text-sm font-bold ${selectedModel === model.id ? 'text-purple-900' : 'text-slate-700'}`}>{model.name}</div>
                                        <div className="text-[10px] text-slate-400">{model.vendor}</div>
                                    </div>
                                    {selectedModel === model.id && <Check size={16} className="text-purple-500" strokeWidth={3}/>}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* Bottom-center: Agent Instructions (renamed from ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸) */}
                <div className="bg-white rounded-[2rem] border-2 border-slate-200 shadow-sm overflow-hidden flex flex-col min-h-[180px]">
                    <div className="p-5 border-b-2 border-slate-100 flex items-center bg-slate-50 flex-shrink-0">
                        <span className="text-xs font-bold uppercase text-slate-400 flex items-center gap-2 tracking-wide"><Settings size={14}/> ì—ì´ì „íŠ¸ ì§€ì¹¨ <span className="text-slate-300 normal-case tracking-normal">Agent Instructions</span></span>
                    </div>
                    <textarea className="w-full flex-1 p-5 text-sm focus:outline-none resize-none leading-relaxed text-slate-600 font-medium" value={agentInstructions} onChange={(e) => setAgentInstructions(e.target.value)} placeholder="ì—ì´ì „íŠ¸ì˜ ì—­í• ê³¼ í–‰ë™ ì§€ì¹¨ì„ ì •ì˜í•˜ì„¸ìš”..."></textarea>
                </div>

                {/* Bottom-right: Skill Summary */}
                <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-[2rem] border-2 border-slate-700 p-5 shadow-sm text-white flex flex-col">
                    <div className="text-[10px] font-bold uppercase tracking-wide text-slate-400 mb-3 flex items-center gap-2"><Code size={12}/> Skill Summary</div>
                    <div className="space-y-2 flex-1">
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">Agent</span>
                            <span className="font-bold text-white truncate ml-2 max-w-[160px]">{agentName}</span>
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">Model</span>
                            <span className="font-bold text-white">{currentModel?.name}</span>
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">Output</span>
                            <span className="font-bold text-violet-400">{currentFormat?.label}</span>
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">Temperature</span>
                            <span className="font-bold text-orange-400">{temperature}</span>
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">Connectors</span>
                            <span className="font-bold text-blue-400">{selectedConnectors.length}ê°œ</span>
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">Plugins</span>
                            <span className="font-bold text-emerald-400">{selectedPlugins.length}ê°œ</span>
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">Guardrails</span>
                            <span className="font-bold text-rose-400">{guardrails.length}ê°œ</span>
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">Status</span>
                            <span className="inline-flex items-center gap-1.5 px-2.5 py-0.5 bg-amber-500/20 text-amber-400 rounded-full text-[10px] font-bold border border-amber-500/30">Draft</span>
                        </div>
                    </div>
                    <button onClick={() => setShowPreview(true)} className="w-full mt-4 pt-3 border-t border-slate-700 text-xs font-bold text-slate-400 hover:text-white flex items-center justify-center gap-2 transition-colors">
                        <Eye size={14}/> skill.md í™•ì¸í•˜ê¸° <ChevronRight size={14}/>
                    </button>
                </div>
            </div>

            {/* ============ Additional Skill Configuration ============ */}
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">

                {/* ì¶œë ¥ í˜•ì‹ (Output Format) */}
                <div className="bg-white rounded-[2rem] border-2 border-slate-200 p-5 shadow-sm">
                    <div className="text-xs font-bold uppercase text-slate-400 mb-4 tracking-wide flex items-center gap-2"><FileText size={14}/> ì¶œë ¥ í˜•ì‹ <span className="text-slate-300 normal-case tracking-normal">Output Format</span></div>
                    <div className="flex flex-wrap gap-2">
                        {outputFormats.map(f => (
                            <button key={f.id} onClick={() => setOutputFormat(f.id)} className={`px-3.5 py-2 rounded-xl text-xs font-bold border-2 transition-all ${outputFormat === f.id ? 'bg-violet-50 text-violet-700 border-violet-500 shadow-sm' : 'bg-white text-slate-400 border-slate-200 hover:border-violet-300 hover:text-slate-600'}`}>
                                {outputFormat === f.id && <Check size={12} className="inline mr-1" strokeWidth={3}/>}
                                {f.label}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Temperature */}
                <div className="bg-white rounded-[2rem] border-2 border-slate-200 p-5 shadow-sm">
                    <div className="text-xs font-bold uppercase text-slate-400 mb-4 tracking-wide flex items-center gap-2"><Thermometer size={14}/> Temperature</div>
                    <div className="space-y-3">
                        <div className="flex items-center justify-between">
                            <span className="text-[10px] text-slate-400 font-bold">ì •í™•í•œ</span>
                            <span className="text-lg font-bold text-slate-900 bg-slate-100 px-3 py-0.5 rounded-lg border border-slate-200">{temperature}</span>
                            <span className="text-[10px] text-slate-400 font-bold">ì°½ì˜ì </span>
                        </div>
                        <input type="range" min="0" max="1" step="0.1" value={temperature} onChange={(e) => setTemperature(parseFloat(e.target.value))} className="w-full h-2 bg-slate-200 rounded-full appearance-none cursor-pointer accent-orange-500"/>
                        <div className="flex justify-between text-[9px] text-slate-300 font-bold px-0.5">
                            <span>0</span>
                            <span>0.5</span>
                            <span>1.0</span>
                        </div>
                    </div>
                </div>

                {/* ê°€ë“œë ˆì¼ (Guardrails) */}
                <div className="bg-white rounded-[2rem] border-2 border-slate-200 p-5 shadow-sm">
                    <div className="text-xs font-bold uppercase text-slate-400 mb-1 tracking-wide flex items-center gap-2"><Shield size={14}/> ê°€ë“œë ˆì¼ <span className="text-slate-300 normal-case tracking-normal">Guardrails</span></div>
                    <p className="text-[10px] text-slate-300 mb-4">ì—ì´ì „íŠ¸ê°€ ì§€ì¼œì•¼ í•  ì œí•œ ì‚¬í•­ì„ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                    <div className="flex flex-wrap gap-2">
                        {guardrailOptions.map(g => (
                            <button key={g} onClick={() => toggleGuardrail(g)} className={`px-3 py-2 rounded-xl text-xs font-bold border-2 transition-all flex items-center gap-1 ${guardrails.includes(g) ? 'bg-rose-50 text-rose-700 border-rose-400 shadow-sm' : 'bg-white text-slate-400 border-slate-200 hover:border-rose-300 hover:text-slate-600'}`}>
                                {guardrails.includes(g) && <Check size={12} strokeWidth={3}/>}
                                {g}
                            </button>
                        ))}
                    </div>
                </div>

                {/* ì˜ˆì‹œ í”„ë¡¬í”„íŠ¸ (Example Prompts) */}
                <div className="bg-white rounded-[2rem] border-2 border-slate-200 p-5 shadow-sm">
                    <div className="text-xs font-bold uppercase text-slate-400 mb-1 tracking-wide flex items-center gap-2"><Lightbulb size={14}/> ì˜ˆì‹œ í”„ë¡¬í”„íŠ¸ <span className="text-slate-300 normal-case tracking-normal">Few-shot Examples</span></div>
                    <p className="text-[10px] text-slate-300 mb-4">ì—ì´ì „íŠ¸ì—ê²Œ ê¸°ëŒ€í•˜ëŠ” ì‚¬ìš© ì˜ˆì‹œë¥¼ ì…ë ¥í•©ë‹ˆë‹¤. (ìµœëŒ€ 3ê°œ)</p>
                    <div className="space-y-2">
                        {examples.map((ex, i) => (
                            <div key={i} className="flex gap-2 items-center">
                                <span className="text-[10px] font-bold text-slate-300 w-5 text-center flex-shrink-0">{i + 1}.</span>
                                <input type="text" value={ex} onChange={(e) => updateExample(i, e.target.value)} className="flex-1 px-3 py-2.5 border-2 border-slate-200 rounded-xl text-xs font-medium focus:outline-none focus:border-amber-500 transition-colors" placeholder="ì˜ˆì‹œ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."/>
                                {examples.length > 1 && (
                                    <button onClick={() => removeExample(i)} className="p-1.5 hover:bg-slate-100 rounded-lg transition-colors flex-shrink-0"><X size={14} className="text-slate-300" strokeWidth={2.5}/></button>
                                )}
                            </div>
                        ))}
                        {examples.length < 3 && (
                            <button onClick={addExample} className="w-full py-2.5 border-2 border-dashed border-slate-200 rounded-xl text-xs font-bold text-slate-400 hover:border-slate-300 hover:text-slate-500 transition-colors flex items-center justify-center gap-1.5">
                                <Plus size={14}/> ì˜ˆì‹œ ì¶”ê°€
                            </button>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

window.AppComponents.AIStudio = AIStudio;
