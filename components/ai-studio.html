const { useMemo, useState } = window.React;
const { Sparkles, Bot, Workflow, Braces, Check, PlayCircle, Clipboard, X, FileText } = window.LucideReact;

const AIStudio = () => {
    const [masterPrompt, setMasterPrompt] = useState('이번 주 게임 트렌드 분석해서 기획팀에 메일 보내줘.');
    const [isAnalyzed, setIsAnalyzed] = useState(false);
    const [isRan, setIsRan] = useState(false);
    const [isCopied, setIsCopied] = useState(false);
    const [isLogOpen, setIsLogOpen] = useState(false);

    const plannedSkills = useMemo(() => {
        const includesTrend = /트렌드|분석/.test(masterPrompt);
        const includesMail = /메일|이메일|보내/.test(masterPrompt);
        const skills = [];

        if (includesTrend) {
            skills.push({
                skill: 'analyze_trend',
                target: 'game',
                route: 'skills://trend-analyzer',
                skillName: 'Trend Analyzer 스킬',
                output: 'weekly_trend_report',
            });
        }

        if (includesMail) {
            skills.push({
                skill: 'send_email',
                recipient: 'planning_team',
                route: 'skills://email-bot',
                skillName: 'Email Bot 스킬',
                output: 'delivery_status',
            });
        }

        if (skills.length === 0) {
            skills.push({
                skill: 'clarify_intent',
                target: 'unknown',
                route: 'skills://intent-clarifier',
                skillName: 'Intent Clarifier 스킬',
                output: 'clarified_instruction',
            });
        }

        return skills;
    }, [masterPrompt]);

    const difyYamlPlan = useMemo(() => {
        const nodesYaml = plannedSkills.map((item, idx) => [
            `  - id: node_${idx + 1}`,
            '    data:',
            '      type: custom',
            `      title: "${item.skillName}"`,
            '      desc: "Master Agent가 선택한 실행 노드"',
            '      selected: false',
            '      variables: []',
            '      typeVersion: "1"',
            '    position:',
            `      x: ${160 + idx * 280}`,
            '      y: 220',
        ].join('\n')).join('\n');

        const edgeYaml = plannedSkills.slice(0, -1).map((_, idx) => [
            `  - id: edge_node_${idx + 1}_node_${idx + 2}`,
            `    source: node_${idx + 1}`,
            `    target: node_${idx + 2}`,
            '    type: custom',
            '    data:',
            `      sourceType: node_${idx + 1}`,
            `      targetType: node_${idx + 2}`,
        ].join('\n')).join('\n');

        const edgesBlock = edgeYaml
            ? ['    edges:', edgeYaml]
            : ['    edges: []'];

        return [
            'app:',
            '  mode: workflow',
            '  name: AI 실험실 실행 초안',
            'kind: app',
            'version: 0.1.0',
            'workflow:',
            '  conversation_variables: []',
            '  environment_variables: []',
            '  graph:',
            '    nodes:',
            nodesYaml,
            ...edgesBlock,
        ].join('\n');
    }, [plannedSkills]);

    const executionLogs = useMemo(() => {
        const startedAt = new Date().toLocaleString('ko-KR');
        return [
            `[${startedAt}] Router 실행 요청 수신`,
            '[orchestrator] Master Prompt를 실행 가능한 스텝으로 변환 완료',
            ...plannedSkills.map((item, idx) => `[node_${idx + 1}] ${item.skill} 호출 완료 -> ${item.output}`),
            '[router] 전체 체인 실행 종료 (status: success)',
        ];
    }, [plannedSkills, isRan]);

    const handleCopyYaml = async () => {
        try {
            await navigator.clipboard.writeText(difyYamlPlan);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 1800);
        } catch (error) {
            const temp = document.createElement('textarea');
            temp.value = difyYamlPlan;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 1800);
        }
    };

    return (
        <div className="space-y-6 animate-in">
            <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-7 shadow-sm">
                <h2 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
                    AI 실험실
                    <span className="text-xs px-3 py-1 rounded-full bg-violet-50 text-violet-700 border border-violet-200 font-bold">Master Prompt Runtime</span>
                </h2>
                <p className="mt-3 text-slate-600 leading-relaxed">
                    상위 Master Agent가 자연어를 Dify YAML 실행 계획으로 변환한 뒤 Router가 하위 스킬 API를 순차 호출하는 오케스트레이션 초안을 설계합니다.
                </p>
            </div>

            <div className="grid grid-cols-1 xl:grid-cols-5 gap-5">
                <div className="xl:col-span-2 space-y-5">
                    <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-5 shadow-sm h-[360px] flex flex-col">
                        <div className="flex items-center gap-2 text-slate-800 font-bold"><Sparkles size={18}/> 1) 입력 (Master Prompt)</div>
                        <textarea
                            value={masterPrompt}
                            onChange={(e) => setMasterPrompt(e.target.value)}
                            className="mt-3 flex-1 w-full border-2 border-slate-200 rounded-2xl p-4 text-sm focus:outline-none focus:border-violet-500"
                        />
                        <button
                            onClick={() => {
                                setIsAnalyzed(true);
                                setIsRan(false);
                            }}
                            className="mt-3 w-full game-btn bg-slate-800 text-white py-3 rounded-2xl font-bold hover:bg-slate-900 transition-colors"
                        >
                            워크플로우 분석
                        </button>
                        <p className="mt-3 text-xs text-slate-500">예시: "이번 주 게임 트렌드 분석해서 기획팀에 메일 보내줘."</p>
                    </div>

                    <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-5 shadow-sm h-[360px] flex flex-col">
                        <div className="flex items-center justify-between gap-3">
                            <div className="flex items-center gap-2 text-slate-800 font-bold"><Bot size={18}/> 2) Master Agent 결과 YAML (Dify)</div>
                            <button
                                type="button"
                                onClick={handleCopyYaml}
                                className="px-3 py-2 text-xs font-bold rounded-xl border border-slate-200 text-slate-700 hover:border-violet-300 hover:text-violet-700 transition-colors inline-flex items-center gap-2"
                            >
                                <Clipboard size={14}/>
                                {isCopied ? '복사됨' : '클립보드 복사'}
                            </button>
                        </div>
                        <pre className="mt-3 flex-1 bg-slate-900 text-slate-100 text-xs rounded-2xl p-4 overflow-x-auto whitespace-pre-wrap">{difyYamlPlan}</pre>
                    </div>
                </div>

                <div className="xl:col-span-3 bg-white border-2 border-slate-200 rounded-[2rem] p-5 shadow-sm">
                    <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                        <div className="flex items-center gap-2 text-slate-800 font-bold"><Workflow size={18}/> 3) Router 실행 순서 (Dify Canvas View)</div>
                        <div className="flex flex-col sm:flex-row gap-2">
                            <button
                                onClick={() => {
                                    setIsAnalyzed(true);
                                    setIsRan(true);
                                }}
                                className="w-full md:w-auto game-btn bg-violet-600 text-white py-3 px-6 rounded-2xl font-bold hover:bg-violet-700 transition-colors flex items-center justify-center gap-2"
                            >
                                <PlayCircle size={18}/> 초안 실행
                            </button>
                            <button
                                onClick={() => setIsLogOpen(true)}
                                className="w-full md:w-auto game-btn bg-slate-100 text-slate-800 py-3 px-6 rounded-2xl font-bold hover:bg-slate-200 transition-colors flex items-center justify-center gap-2 border border-slate-200"
                            >
                                <FileText size={18}/> 결과 확인
                            </button>
                        </div>
                    </div>
                    <div className="mt-3 p-4 border border-slate-200 rounded-2xl bg-gradient-to-b from-slate-50 to-violet-50/40 overflow-x-auto">
                        <div className="min-w-[700px]">
                            <div className="text-[11px] font-bold text-slate-500 mb-4">Canvas Preview · Router Graph</div>
                            <div className="flex items-center gap-4">
                                {plannedSkills.map((item, idx) => (
                                    <div key={item.skill + idx} className="flex items-center gap-4">
                                        <div className="relative border-2 border-violet-200 rounded-2xl p-4 bg-white min-w-[210px] shadow-sm">
                                            <div className="absolute -top-2 left-4 px-2 py-0.5 rounded-md bg-violet-100 text-violet-700 text-[10px] font-black">NODE {idx + 1}</div>
                                            <div className="mt-2 flex items-center justify-between">
                                                <div className="font-semibold text-slate-800 text-sm">{item.skillName}</div>
                                                <div className="w-3 h-3 rounded-full bg-emerald-400 border-2 border-emerald-100"/>
                                            </div>
                                            <div className="text-xs text-slate-500 mt-2">{item.route}</div>
                                            <div className="mt-3 inline-flex items-center gap-1 text-[11px] font-bold text-violet-700 bg-violet-50 border border-violet-200 px-2 py-1 rounded-lg">
                                                <Braces size={12}/> {item.skill}
                                            </div>
                                            <div className="mt-2 text-[11px] text-slate-500">output: {item.output}</div>
                                        </div>
                                        {idx < plannedSkills.length - 1 && (
                                            <div className="flex items-center gap-2">
                                                <div className="w-8 h-[2px] bg-violet-300"/>
                                                <div className="text-violet-500 text-lg font-black">➜</div>
                                                <div className="w-8 h-[2px] bg-violet-300"/>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="mt-4">
                        {isAnalyzed && !isRan && <div className="text-xs font-bold text-blue-700 bg-blue-50 border border-blue-200 rounded-xl px-3 py-2 inline-flex items-center gap-2"><Check size={14}/> 워크플로우 분석이 완료되었습니다.</div>}
                        {isRan && <div className="text-xs font-bold text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-xl px-3 py-2 inline-flex items-center gap-2"><Check size={14}/> 초안 실행 결과가 갱신되었습니다.</div>}
                    </div>
                </div>
            </div>

            {isLogOpen && (
                <div className="fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-[1px] flex items-center justify-center px-4">
                    <div className="w-full max-w-3xl bg-white border-2 border-slate-200 rounded-3xl shadow-xl">
                        <div className="flex items-center justify-between p-5 border-b border-slate-200">
                            <div>
                                <h3 className="text-lg font-bold text-slate-900">Router 실행 결과 로그</h3>
                                <p className="text-xs text-slate-500 mt-1">초안 실행의 단계별 로그를 확인할 수 있습니다.</p>
                            </div>
                            <button
                                type="button"
                                onClick={() => setIsLogOpen(false)}
                                className="w-9 h-9 rounded-xl border border-slate-200 text-slate-500 hover:text-slate-900 hover:border-slate-300 flex items-center justify-center"
                            >
                                <X size={16}/>
                            </button>
                        </div>
                        <div className="p-5 space-y-3 max-h-[420px] overflow-y-auto">
                            {executionLogs.map((line, idx) => (
                                <div key={line + idx} className="text-xs rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 font-mono text-slate-700">
                                    {line}
                                </div>
                            ))}
                        </div>
                        <div className="px-5 pb-5 flex justify-end">
                            <button
                                type="button"
                                onClick={() => setIsLogOpen(false)}
                                className="game-btn bg-slate-800 text-white py-2.5 px-5 rounded-2xl font-bold hover:bg-slate-900 transition-colors"
                            >
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

window.AppComponents.AIStudio = AIStudio;
