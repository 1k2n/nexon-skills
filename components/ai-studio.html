const { useMemo, useState } = window.React;
const { FlaskConical, Bot, GitBranch, Copy, Check, Eye, Play, Sparkles, ArrowRight, FileJson, Terminal, Mail, BarChart3 } = window.LucideReact;
const { ModalLayer } = window.AppComponents;

const AIStudio = () => {
    const [userPrompt, setUserPrompt] = useState('이번 주 게임 트렌드 분석해서 기획팀에 메일 보내줘.');
    const [showPreview, setShowPreview] = useState(false);
    const [copied, setCopied] = useState(false);
    const [outputFormat, setOutputFormat] = useState('master');

    const difyApps = [
        {
            id: 'trend-analyzer',
            action: 'analyze_trend',
            name: 'Trend Analyzer 앱',
            endpoint: '/v1/apps/trend-analyzer/run',
            desc: '게임/커뮤니티/지표 데이터를 분석해 주간 트렌드 인사이트를 생성합니다.',
            icon: BarChart3,
        },
        {
            id: 'email-bot',
            action: 'send_email',
            name: 'Email Bot 앱',
            endpoint: '/v1/apps/email-bot/run',
            desc: '요약 결과를 수신 그룹에 맞춰 이메일로 전송합니다.',
            icon: Mail,
        },
    ];

    const actionExamples = [
        { action: 'analyze_trend', target: 'game' },
        { action: 'send_email', recipient: 'planning_team' },
    ];

    const parsedActions = useMemo(() => {
        const normalized = userPrompt.toLowerCase();
        const actions = [];

        if (normalized.includes('트렌드') || normalized.includes('분석')) {
            actions.push({ action: 'analyze_trend', target: normalized.includes('게임') ? 'game' : 'service' });
        }

        if (normalized.includes('메일') || normalized.includes('이메일') || normalized.includes('send')) {
            actions.push({ action: 'send_email', recipient: normalized.includes('기획') ? 'planning_team' : 'ops_team' });
        }

        if (actions.length === 0) {
            return [{ action: 'delegate_to_human', reason: 'no_supported_action_detected' }];
        }

        return actions;
    }, [userPrompt]);

    const routerSteps = useMemo(() => {
        return parsedActions.map((step, index) => {
            const app = difyApps.find((candidate) => candidate.action === step.action);
            return {
                order: index + 1,
                action: step.action,
                payload: step,
                appName: app?.name || 'Fallback Handler',
                endpoint: app?.endpoint || '/v1/apps/fallback/run',
            };
        });
    }, [parsedActions]);

    const masterPromptSpec = [
        '# Master Prompt Orchestrator Spec',
        '',
        '## User Input',
        userPrompt,
        '',
        '## Parsed Action JSON',
        '```json',
        JSON.stringify(parsedActions, null, 2),
        '```',
        '',
        '## Router Execution Plan',
        ...routerSteps.map((step) => `- ${step.order}. ${step.appName} 호출 (${step.endpoint})`),
        '',
        '## Notes',
        '- Dify UI를 거치지 않고 상위 Master Agent가 하위 앱들을 순차 실행합니다.',
        '- 결과물은 Agent/Workflow/기타 산출물이라도 모두 Skill 초안으로 관리합니다.',
    ].join('\n');

    const routerYaml = [
        'runtime: dify-api',
        'mode: master-prompt-orchestration',
        'input:',
        `  prompt: "${userPrompt}"`,
        'actions:',
        ...parsedActions.map((step) => `  - ${JSON.stringify(step)}`),
        'router:',
        ...routerSteps.map((step) => `  - order: ${step.order}\n    action: ${step.action}\n    app: ${step.appName}\n    endpoint: ${step.endpoint}`),
    ].join('\n');

    const outputContent = () => {
        if (outputFormat === 'yaml') return routerYaml;
        if (outputFormat === 'json') return JSON.stringify({ prompt: userPrompt, actions: parsedActions, router: routerSteps }, null, 2);
        return masterPromptSpec;
    };

    const handleCopy = () => {
        navigator.clipboard.writeText(outputContent()).catch(() => {});
        setCopied(true);
        setTimeout(() => setCopied(false), 1500);
    };

    return (
        <>
            {showPreview && (
                <ModalLayer onClose={() => setShowPreview(false)} maxWidth="max-w-3xl">
                    <div className="flex items-center justify-between px-6 py-4 border-b-2 border-slate-100 bg-slate-50">
                        <div>
                            <h3 className="font-bold text-slate-900">Master Prompt Output</h3>
                            <p className="text-xs text-slate-400">Natural Language → Action JSON → Dify Router Plan</p>
                        </div>
                        <button onClick={handleCopy} className="px-3 py-2 text-xs font-bold rounded-lg border border-slate-200 hover:bg-slate-100 flex items-center gap-1.5">
                            {copied ? <><Check size={14}/> 복사됨</> : <><Copy size={14}/> 복사</>}
                        </button>
                    </div>
                    <div className="px-6 pt-4 flex gap-2">
                        {[
                            { id: 'master', label: 'Master Prompt' },
                            { id: 'yaml', label: 'Router YAML' },
                            { id: 'json', label: 'Router JSON' },
                        ].map((format) => (
                            <button
                                key={format.id}
                                onClick={() => { setOutputFormat(format.id); setCopied(false); }}
                                className={`px-3 py-1.5 rounded-full text-xs font-bold border ${outputFormat === format.id ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-500 border-slate-200'}`}
                            >
                                {format.label}
                            </button>
                        ))}
                    </div>
                    <div className="p-6 max-h-[62vh] overflow-y-auto">
                        <pre className="bg-slate-900 text-slate-100 p-5 rounded-2xl text-sm whitespace-pre-wrap">{outputContent()}</pre>
                    </div>
                </ModalLayer>
            )}

            <div className="space-y-6 animate-in">
                <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-6 shadow-sm">
                    <h2 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
                        <FlaskConical size={28} className="text-purple-600"/>
                        AI 실험실
                    </h2>
                    <p className="text-slate-500 mt-2">
                        Dify UI를 거치지 않고, 상위 Master Prompt가 하위 Dify 앱들을 연쇄 실행하는 오케스트레이션 스케치를 설계합니다.
                    </p>
                </div>

                <div className="grid grid-cols-1 xl:grid-cols-3 gap-5">
                    <div className="xl:col-span-2 bg-white border-2 border-slate-200 rounded-[2rem] p-6 shadow-sm space-y-5">
                        <div className="flex items-center justify-between">
                            <h3 className="text-lg font-bold text-slate-900 flex items-center gap-2"><Sparkles size={18}/> Master Prompt</h3>
                            <button onClick={() => setShowPreview(true)} className="px-4 py-2 bg-slate-900 text-white rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-slate-800">
                                <Eye size={16}/> 출력 보기
                            </button>
                        </div>
                        <textarea
                            value={userPrompt}
                            onChange={(e) => setUserPrompt(e.target.value)}
                            className="w-full h-28 border-2 border-slate-200 rounded-2xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-blue-500"
                        />
                        <div className="grid md:grid-cols-2 gap-4">
                            <div className="rounded-2xl border-2 border-blue-200 bg-blue-50 p-4">
                                <div className="text-xs font-bold text-blue-600 mb-2 flex items-center gap-2"><FileJson size={14}/> Master Agent 해석 결과</div>
                                <pre className="text-xs text-slate-700 whitespace-pre-wrap">{JSON.stringify(parsedActions, null, 2)}</pre>
                            </div>
                            <div className="rounded-2xl border-2 border-purple-200 bg-purple-50 p-4">
                                <div className="text-xs font-bold text-purple-600 mb-2 flex items-center gap-2"><GitBranch size={14}/> Router 실행 순서</div>
                                <div className="space-y-2">
                                    {routerSteps.map((step) => (
                                        <div key={`${step.order}-${step.action}`} className="text-xs text-slate-700 font-medium bg-white border border-purple-200 rounded-lg px-3 py-2">
                                            {step.order}. {step.action} → {step.appName}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-slate-900 text-white rounded-[2rem] p-6 border-2 border-slate-800 shadow-sm">
                        <div className="text-xs uppercase tracking-wide text-slate-400 font-bold">의의</div>
                        <h3 className="mt-2 text-lg font-bold">자연어 1회 입력으로 연쇄 실행</h3>
                        <p className="mt-3 text-sm text-slate-300 leading-relaxed">
                            사용자는 구체적인 워크플로우를 몰라도 됩니다. Master Agent가 명령을 구조화하고 Router가 Dify 앱 API를 순차 호출합니다.
                        </p>
                        <button className="mt-5 w-full px-4 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-sm font-bold flex items-center justify-center gap-2">
                            <Play size={16}/> 스케치 실행
                        </button>
                    </div>
                </div>

                <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-6 shadow-sm">
                    <h3 className="text-lg font-bold text-slate-900 flex items-center gap-2"><Terminal size={18}/> Dify App Router</h3>
                    <p className="text-sm text-slate-500 mt-1">Router는 Action JSON을 보고 앱 API를 순서대로 호출합니다.</p>
                    <div className="mt-4 grid md:grid-cols-2 gap-4">
                        {difyApps.map((app) => {
                            const Icon = app.icon;
                            return (
                                <div key={app.id} className="border border-slate-200 rounded-2xl p-4 bg-slate-50">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <div className="p-2 rounded-lg bg-white border border-slate-200"><Icon size={16} className="text-slate-700"/></div>
                                            <h4 className="font-bold text-slate-800">{app.name}</h4>
                                        </div>
                                        <span className="text-[11px] px-2 py-1 bg-slate-900 text-white rounded-full">{app.action}</span>
                                    </div>
                                    <p className="mt-2 text-sm text-slate-600">{app.desc}</p>
                                    <div className="mt-3 text-xs font-mono text-slate-500 bg-white border border-slate-200 rounded-lg px-2 py-1.5">POST {app.endpoint}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                <div className="bg-gradient-to-r from-slate-900 to-slate-800 rounded-[2rem] p-6 text-white shadow-sm border-2 border-slate-800">
                    <h3 className="text-lg font-bold flex items-center gap-2"><Bot size={18}/> Reference Flow</h3>
                    <div className="mt-4 grid md:grid-cols-4 gap-3 text-sm">
                        <div className="bg-white/10 border border-white/10 rounded-xl p-3">입력<br/><span className="text-slate-300 text-xs">"이번 주 게임 트렌드 분석해서 기획팀에 메일 보내줘."</span></div>
                        <div className="bg-white/10 border border-white/10 rounded-xl p-3">Master Agent<br/><span className="text-slate-300 text-xs">자연어를 Action JSON으로 변환</span></div>
                        <div className="bg-white/10 border border-white/10 rounded-xl p-3">Router<br/><span className="text-slate-300 text-xs">Trend Analyzer → Email Bot 순차 호출</span></div>
                        <div className="bg-white/10 border border-white/10 rounded-xl p-3">결과<br/><span className="text-slate-300 text-xs">기획팀 전달용 분석 리포트 메일 발송</span></div>
                    </div>
                    <div className="mt-3 flex items-center gap-2 text-slate-300 text-xs">
                        {actionExamples.map((example, idx) => (
                            <div key={`${example.action}-${idx}`} className="inline-flex items-center gap-2">
                                <code className="bg-white/10 border border-white/10 px-2 py-1 rounded">{JSON.stringify(example)}</code>
                                {idx < actionExamples.length - 1 && <ArrowRight size={14} />}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </>
    );
};

window.AppComponents.AIStudio = AIStudio;
