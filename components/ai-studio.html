const { useMemo, useState } = window.React;
const { Sparkles, Bot, Workflow, Braces, Check, PlayCircle, Clipboard, X, FileText } = window.LucideReact;

const defaultPrompt = '오늘 시작한 "설맞이 일일 퀘스트" 의 매출 효과를 일별로 분석하고, 그 기간동안의 동접 변화를 추적하고, 전날 결과를 취합해서 매일 아침 9시에 기획팀 메일과 슬랙 채널에 쏴줘.';

const buildWorkflowFromPrompt = (promptText) => {
    const prompt = promptText || defaultPrompt;
    const campaignMatch = prompt.match(/"([^"]+)"/);
    const campaignName = campaignMatch ? campaignMatch[1] : '일일 라이브 이벤트';
    const includesSlack = /슬랙|slack/i.test(prompt);
    const includesMail = /메일|이메일|email/i.test(prompt);
    const includesCcu = /동접|ccu|접속/i.test(prompt);
    const schedule = /9시|09:00/.test(prompt) ? '0 9 * * *' : '0 10 * * *';

    const nodes = [
        { id: 'trigger_1', title: `Daily Scheduler (${schedule})`, skill: 'cron-scheduler', route: 'system://scheduler', output: 'run_context', stage: 'start', x: 90, y: 220 },
        { id: 'node_1', title: 'AI 서치 에이전트', skill: 'skills:ai-search-agent', route: 'skills://ai-search-agent', output: 'daily_revenue_by_date', stage: 'parallel-a', x: 350, y: 130 },
        { id: 'node_2', title: 'NEMO RT 에이전트', skill: 'skills:nemort-agent', route: 'skills://nemort-agent', output: includesCcu ? 'daily_ccu_change' : 'daily_engagement_change', stage: 'parallel-a', x: 350, y: 310 },
        { id: 'node_5', title: 'Daily Metrics Joiner', skill: 'metrics-joiner', route: 'skills://metrics-joiner', output: 'yesterday_summary_payload', stage: 'merge', x: 640, y: 220 },
    ];

    if (includesMail) {
        nodes.push({ id: 'node_3', title: 'Email Summary', skill: 'skills:email-summary', route: 'skills://email-summary', output: 'email_delivery_status', stage: 'parallel-b', x: 920, y: 130 });
    }
    if (includesSlack) {
        nodes.push({ id: 'node_4', title: 'Slack Notifier', skill: 'skills:slack-notifier', route: 'skills://slack-notifier', output: 'slack_delivery_status', stage: 'parallel-b', x: 920, y: 310 });
    }

    nodes.push({ id: 'node_6', title: 'Run Audit Logger', skill: 'audit-logger', route: 'system://ops-audit', output: 'run_audit_record', stage: 'end', x: 1180, y: 220 });

    const edges = [
        { id: 'edge_trigger_node1', source: 'trigger_1', target: 'node_1' },
        { id: 'edge_trigger_node2', source: 'trigger_1', target: 'node_2' },
        { id: 'edge_node1_node5', source: 'node_1', target: 'node_5' },
        { id: 'edge_node2_node5', source: 'node_2', target: 'node_5' },
    ];

    if (includesMail) edges.push({ id: 'edge_node5_node3', source: 'node_5', target: 'node_3' });
    if (includesSlack) edges.push({ id: 'edge_node5_node4', source: 'node_5', target: 'node_4' });
    if (includesMail) edges.push({ id: 'edge_node3_node6', source: 'node_3', target: 'node_6' });
    if (includesSlack) edges.push({ id: 'edge_node4_node6', source: 'node_4', target: 'node_6' });
    if (!includesMail && !includesSlack) edges.push({ id: 'edge_node5_node6', source: 'node_5', target: 'node_6' });

    return { campaignName, schedule, includesMail, includesSlack, nodes, edges };
};

const AIStudio = () => {
    const [masterPrompt, setMasterPrompt] = useState(defaultPrompt);
    const [analyzedPrompt, setAnalyzedPrompt] = useState(defaultPrompt);
    const [isAnalyzed, setIsAnalyzed] = useState(false);
    const [isRan, setIsRan] = useState(false);
    const [isCopied, setIsCopied] = useState(false);
    const [isLogOpen, setIsLogOpen] = useState(false);
    const [isSkillModalOpen, setIsSkillModalOpen] = useState(false);
    const [registeredSkillBundles, setRegisteredSkillBundles] = useState([]);

    const workflow = useMemo(() => buildWorkflowFromPrompt(analyzedPrompt), [analyzedPrompt]);

    const stageGroups = useMemo(() => ([
        { label: 'Stage 0 · 트리거', parallel: false, nodes: workflow.nodes.filter((node) => node.stage === 'start') },
        { label: 'Stage 1 · 병렬 실행 (노드1 + 노드2)', parallel: true, nodes: workflow.nodes.filter((node) => node.stage === 'parallel-a') },
        { label: 'Stage 2 · 결과 병합', parallel: false, nodes: workflow.nodes.filter((node) => node.stage === 'merge') },
        { label: 'Stage 3 · 병렬 전송', parallel: true, nodes: workflow.nodes.filter((node) => node.stage === 'parallel-b') },
        { label: 'Stage 4 · 감사 로그', parallel: false, nodes: workflow.nodes.filter((node) => node.stage === 'end') },
    ]), [workflow.nodes]);

    const difyYamlPlan = useMemo(() => {
        const nodeBlock = workflow.nodes.map((node) => [
            `  - id: ${node.id}`,
            '    data:',
            '      type: custom',
            `      title: "${node.title}"`,
            `      desc: "${node.skill}"`,
            '      selected: false',
            '      variables: []',
            '      typeVersion: "1"',
            '    position:',
            `      x: ${node.x}`,
            `      y: ${node.y}`,
        ].join('\n')).join('\n');

        const edgeBlock = workflow.edges.map((edge) => [
            `  - id: ${edge.id}`,
            `    source: ${edge.source}`,
            `    target: ${edge.target}`,
            '    type: custom',
            '    data:',
            `      sourceType: ${edge.source}`,
            `      targetType: ${edge.target}`,
        ].join('\n')).join('\n');

        return [
            'app:',
            '  mode: workflow',
            `  name: ${workflow.campaignName} 성과 브리핑 자동화`,
            'kind: app',
            'version: 0.1.0',
            'workflow:',
            '  conversation_variables:',
            '    - name: schedule',
            `      value: "${workflow.schedule}"`,
            '    - name: target_campaign',
            `      value: "${workflow.campaignName}"`,
            '  environment_variables: []',
            '  graph:',
            '    nodes:',
            nodeBlock,
            '    edges:',
            edgeBlock,
        ].join('\n');
    }, [workflow]);

    const executionLogs = useMemo(() => {
        const startedAt = new Date().toLocaleString('ko-KR');
        const channelSummary = [workflow.includesMail ? 'email' : null, workflow.includesSlack ? 'slack' : null].filter(Boolean).join('+') || 'ops-dashboard';
        return [
            `[${startedAt}] Router 실행 요청 수신`,
            `[orchestrator] Prompt 분석 완료: ${workflow.campaignName}`,
            `[scheduler] cron=${workflow.schedule} 트리거 적용`,
            '[parallel-group:A] node_1, node_2 동시 실행',
            '[node_1] 일별 매출/전환 지표 집계 완료',
            '[node_2] 동접/참여 지표 추적 완료',
            '[node_5] 전날 요약 payload 생성 완료',
            '[parallel-group:B] 후속 발송 노드 실행',
            `[delivery] 채널 전송 완료 -> ${channelSummary}`,
            '[router] 전체 그래프 실행 종료 (status: success)',
        ];
    }, [workflow]);

    const handleAnalyze = () => {
        setAnalyzedPrompt(masterPrompt);
        setIsAnalyzed(true);
        setIsRan(false);
    };

    const handleCopyYaml = async () => {
        try {
            await navigator.clipboard.writeText(difyYamlPlan);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 1800);
        } catch (error) {
            const temp = document.createElement('textarea');
            temp.value = difyYamlPlan;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 1800);
        }
    };

    const handleRegisterSkill = () => {
        const newSkill = {
            id: `skill-bundle-${Date.now()}`,
            name: `${workflow.campaignName} 자동화 번들`,
            prompt: analyzedPrompt,
            nodes: workflow.nodes.length,
            createdAt: new Date().toLocaleString('ko-KR'),
            includesRun: isRan,
        };
        setRegisteredSkillBundles((prev) => [newSkill, ...prev]);
        setIsSkillModalOpen(false);
    };

    return (
        <div className="space-y-6 animate-in min-h-[calc(100vh-120px)]">
            <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-7 shadow-sm">
                <h2 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
                    AI 실험실
                    <span className="text-xs px-3 py-1 rounded-full bg-violet-50 text-violet-700 border border-violet-200 font-bold">Master Prompt Runtime</span>
                </h2>
                <p className="mt-3 text-slate-600 leading-relaxed">
                    상위 Master Agent가 자연어를 Dify YAML 실행 계획으로 변환한 뒤 Router가 병렬/병합 흐름을 포함한 하위 스킬 오케스트레이션을 실행합니다.
                </p>
            </div>

            <div className="grid grid-cols-1 xl:grid-cols-2 xl:grid-rows-[auto_minmax(0,1fr)] gap-5 xl:h-[calc(100vh-270px)]">
                <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-5 shadow-sm min-h-[220px] xl:min-h-[220px] flex flex-col">
                    <div className="flex items-center gap-2 text-slate-800 font-bold"><Sparkles size={18}/> 1) 입력 (Master Prompt)</div>
                    <textarea
                        value={masterPrompt}
                        onChange={(e) => setMasterPrompt(e.target.value)}
                        className="mt-3 flex-1 w-full border-2 border-slate-200 rounded-2xl p-4 text-sm focus:outline-none focus:border-violet-500"
                    />
                    <button
                        onClick={handleAnalyze}
                        className="mt-3 w-full game-btn bg-slate-800 text-white py-3 rounded-2xl font-bold hover:bg-slate-900 transition-colors"
                    >
                        워크플로우 분석
                    </button>
                    <p className="mt-3 text-xs text-slate-500">버튼 동작: 2) YAML + 3) 캔버스/로그가 현재 프롬프트 기준으로 갱신됩니다.</p>
                </div>

                <div className="bg-white border-2 border-slate-200 rounded-[2rem] p-5 shadow-sm min-h-[220px] xl:min-h-[220px] flex flex-col">
                    <div className="flex items-center justify-between gap-3">
                        <div className="flex items-center gap-2 text-slate-800 font-bold"><Bot size={18}/> 2) Master Agent 결과 YAML (Dify)</div>
                        <button
                            type="button"
                            onClick={handleCopyYaml}
                            className="px-3 py-2 text-xs font-bold rounded-xl border border-slate-200 text-slate-700 hover:border-violet-300 hover:text-violet-700 transition-colors inline-flex items-center gap-2"
                        >
                            <Clipboard size={14}/>
                            {isCopied ? '복사됨' : '클립보드 복사'}
                        </button>
                    </div>
                    <pre className="mt-3 flex-1 bg-slate-900 text-slate-100 text-xs rounded-2xl p-4 overflow-auto whitespace-pre-wrap">{difyYamlPlan}</pre>
                </div>

                <div className="xl:col-span-2 bg-white border-2 border-slate-200 rounded-[2rem] p-5 shadow-sm h-full min-h-[460px] xl:min-h-0 flex flex-col">
                    <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                        <div className="flex items-center gap-2 text-slate-800 font-bold"><Workflow size={18}/> 3) Router 실행 순서 (Dify Canvas View)</div>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 w-full md:w-auto">
                            <button
                                onClick={() => {
                                    setIsAnalyzed(true);
                                    setIsRan(true);
                                }}
                                className="w-full game-btn bg-violet-600 text-white py-3 px-5 rounded-2xl font-bold hover:bg-violet-700 transition-colors flex items-center justify-center gap-2"
                            >
                                <PlayCircle size={18}/> 초안 실행
                            </button>
                            <button
                                onClick={() => setIsLogOpen(true)}
                                className="w-full game-btn bg-slate-100 text-slate-800 py-3 px-5 rounded-2xl font-bold hover:bg-slate-200 transition-colors flex items-center justify-center gap-2 border border-slate-200"
                            >
                                <FileText size={18}/> 결과 확인
                            </button>
                            <button
                                onClick={() => setIsSkillModalOpen(true)}
                                className="w-full game-btn bg-emerald-50 text-emerald-800 py-3 px-5 rounded-2xl font-bold hover:bg-emerald-100 transition-colors flex items-center justify-center gap-2 border border-emerald-200"
                            >
                                <Bot size={18}/> 스킬 등록
                            </button>
                        </div>
                    </div>
                    <div className="mt-3 p-4 border border-slate-200 rounded-2xl bg-gradient-to-b from-slate-50 to-violet-50/40 overflow-auto flex-1 min-h-0">
                        <div className="min-w-[1080px] h-full flex items-stretch gap-3">
                            {stageGroups.map((group, idx) => (
                                <div key={group.label} className="flex items-stretch gap-3 h-full">
                                    <div className="w-[200px] rounded-2xl border border-violet-200 bg-white/90 p-3 h-full">
                                        <div className="text-[10px] font-black text-violet-700 mb-2">{group.label}</div>
                                        <div className="space-y-2">
                                            {group.nodes.map((node) => (
                                                <div key={node.id} className="border border-slate-200 rounded-xl p-2 bg-white">
                                                    <div className="text-xs font-bold text-slate-800">{node.title}</div>
                                                    <div className="mt-1 text-[11px] text-slate-500">{node.skill}</div>
                                                    <div className="mt-1 inline-flex items-center gap-1 text-[10px] font-bold text-violet-700 bg-violet-50 border border-violet-200 px-1.5 py-0.5 rounded-md">
                                                        <Braces size={11}/> {node.id}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        {group.parallel && <div className="mt-2 text-[10px] font-bold text-emerald-700">Parallel</div>}
                                    </div>
                                    {idx < stageGroups.length - 1 && (
                                        <div className="flex items-center gap-1">
                                            <div className="w-6 h-[2px] bg-violet-300"/>
                                            <div className="text-violet-500 text-lg font-black">➜</div>
                                            <div className="w-6 h-[2px] bg-violet-300"/>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="mt-4 flex flex-wrap gap-2">
                        {isAnalyzed && <div className="text-xs font-bold text-blue-700 bg-blue-50 border border-blue-200 rounded-xl px-3 py-2 inline-flex items-center gap-2"><Check size={14}/> 워크플로우 분석 반영 완료</div>}
                        {isRan && <div className="text-xs font-bold text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-xl px-3 py-2 inline-flex items-center gap-2"><Check size={14}/> 초안 실행 결과가 갱신되었습니다.</div>}
                        {registeredSkillBundles.length > 0 && <div className="text-xs font-bold text-violet-700 bg-violet-50 border border-violet-200 rounded-xl px-3 py-2 inline-flex items-center gap-2"><Check size={14}/> 신규 스킬 {registeredSkillBundles.length}건 등록 완료</div>}
                    </div>
                </div>
            </div>

            {isSkillModalOpen && (
                <div className="fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-[1px] flex items-center justify-center px-4">
                    <div className="w-full max-w-2xl bg-white border-2 border-slate-200 rounded-3xl shadow-xl">
                        <div className="flex items-center justify-between p-5 border-b border-slate-200">
                            <div>
                                <h3 className="text-lg font-bold text-slate-900">스킬 등록</h3>
                                <p className="text-xs text-slate-500 mt-1">1) 프롬프트, 2) YAML, 3) 실행 흐름을 하나의 스킬 번들로 등록합니다.</p>
                            </div>
                            <button
                                type="button"
                                onClick={() => setIsSkillModalOpen(false)}
                                className="w-9 h-9 rounded-xl border border-slate-200 text-slate-500 hover:text-slate-900 hover:border-slate-300 flex items-center justify-center"
                            >
                                <X size={16}/>
                            </button>
                        </div>
                        <div className="p-5 space-y-3">
                            <div className="rounded-xl border border-slate-200 bg-slate-50 p-3">
                                <div className="text-xs text-slate-500">스킬명</div>
                                <div className="text-sm font-bold text-slate-800 mt-1">{workflow.campaignName} 자동화 번들</div>
                            </div>
                            <div className="rounded-xl border border-slate-200 bg-slate-50 p-3">
                                <div className="text-xs text-slate-500">포함 노드</div>
                                <div className="text-sm font-bold text-slate-800 mt-1">{workflow.nodes.length}개 (프롬프트 기반 자동 구성)</div>
                            </div>
                            <div className="rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs text-slate-600">
                                {isRan ? '실행 결과까지 포함하여 등록됩니다.' : '실행 전 상태입니다. 등록은 가능하지만 실행 로그는 제외됩니다.'}
                            </div>
                        </div>
                        <div className="px-5 pb-5 flex justify-end gap-2">
                            <button
                                type="button"
                                onClick={() => setIsSkillModalOpen(false)}
                                className="game-btn bg-slate-100 text-slate-800 py-2.5 px-5 rounded-2xl font-bold hover:bg-slate-200 transition-colors border border-slate-200"
                            >
                                취소
                            </button>
                            <button
                                type="button"
                                onClick={handleRegisterSkill}
                                className="game-btn bg-emerald-600 text-white py-2.5 px-5 rounded-2xl font-bold hover:bg-emerald-700 transition-colors"
                            >
                                등록 요청
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {isLogOpen && (
                <div className="fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-[1px] flex items-center justify-center px-4">
                    <div className="w-full max-w-3xl bg-white border-2 border-slate-200 rounded-3xl shadow-xl">
                        <div className="flex items-center justify-between p-5 border-b border-slate-200">
                            <div>
                                <h3 className="text-lg font-bold text-slate-900">Router 실행 결과 로그</h3>
                                <p className="text-xs text-slate-500 mt-1">초안 실행의 단계별 로그를 확인할 수 있습니다.</p>
                            </div>
                            <button
                                type="button"
                                onClick={() => setIsLogOpen(false)}
                                className="w-9 h-9 rounded-xl border border-slate-200 text-slate-500 hover:text-slate-900 hover:border-slate-300 flex items-center justify-center"
                            >
                                <X size={16}/>
                            </button>
                        </div>
                        <div className="p-5 space-y-3 max-h-[420px] overflow-y-auto">
                            {executionLogs.map((line, idx) => (
                                <div key={line + idx} className="text-xs rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 font-mono text-slate-700">
                                    {line}
                                </div>
                            ))}
                        </div>
                        <div className="px-5 pb-5 flex justify-end">
                            <button
                                type="button"
                                onClick={() => setIsLogOpen(false)}
                                className="game-btn bg-slate-800 text-white py-2.5 px-5 rounded-2xl font-bold hover:bg-slate-900 transition-colors"
                            >
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

window.AppComponents.AIStudio = AIStudio;
